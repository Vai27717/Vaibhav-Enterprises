<!doctype html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="icon-192.png">

<link rel="apple-touch-icon" href="icon-512.jpg">

<link rel="icon" sizes="192x192" href="icon-192.png">
 <link rel="manifest" href="manifest.json">

<meta name="theme-color" content="#000000">
 
 <head>
<meta charset="utf-8" />
<title>Vaibhav Enterprises - App (All in one)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<style>
 body {
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
    background: #2c2c2c;   /* Dark Grey background */
    color: #ffffff;        /* White font */
  }

  /* --- Top Navigation Bar --- */
  /* --- Top Navigation Bar --- */
.nav {
    position: sticky;       /* Header ekach jaagi thambel */
    top: 0;                 /* Top la stick hoil */
    z-index: 10;            /* Content chya var rahil */

    background: #3a3a3a;
    padding: .6rem;
    border-radius: .5rem;
    display: flex;
    gap: .5rem;
    align-items: center;
    flex-wrap: wrap;
    box-shadow: 0 6px 18px rgba(0,0,0,.4);
    margin-bottom: 1rem;
}
  /* --- Buttons ‡§§‡§∏‡•á‡§ö ‡§∞‡§æ‡§π‡§§‡•Ä‡§≤ (blue) --- */
  .smallbtn {
    padding: .4rem .7rem;
    border-radius: .375rem;
    background: #0ea5e9;
    color: #fff;
    border: none;
    font-weight: 600;
    cursor: pointer;
  }

  /* --- Cards --- */
  .card {
    background: #3a3a3a;   /* Light Grey (dark theme compatible) */
    padding: 1rem;
    border-radius: .75rem;
    box-shadow: 0 6px 18px rgba(0,0,0,.4);
    margin: 8px 0;
    color: #ffffff;
  }

  /* --- Input, Textarea, Select --- */
  input, textarea, select {
    background: #4a4a4a;   /* ‡§π‡§≤‡§ï‡§æ ‡§ó‡•ç‡§∞‡•á */
    color: #ffffff;
    border: 1px solid #666;
    padding: .45rem;
    border-radius: .375rem;
  }

  /* --- Tables --- */
  table {
    background: #3a3a3a;
    color: #ffffff;
  }
  table th, table td {
    padding: .45rem .5rem;
    border-bottom: 1px solid #666;
    font-size: 13px;
  }
  table th {
    background: #4a4a4a;
  }

  /* --- Headings --- */
  h2, h3, h4 {
    font-weight: 700;
    color: #ffffff;
  }

  /* --- Muted Text --- */
  .muted {
    color: #bbbbbb;
    font-size: 13px;
  }

  /* --- Item Rows --- */
  .item-row input, 
  .item-row textarea {
    background: #4a4a4a;
    color: #ffffff;
    padding: 6px 8px;
    font-size: 14px;
    height: 38px;
  }

  .item-row textarea {
    height: 60px;
  }

/* ‚úÖ ‡§∏‡§∞‡•ç‡§µ input, textarea, select ‡§∏‡§æ‡§†‡•Ä */
input, textarea, select {
  background-color: #4a4a4a !important;
  color: #ffffff !important;
  border: 1px solid #666 !important;
}

/* ‚úÖ Card ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ö‡§∏‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏‡§∏‡§æ‡§†‡•Ä */
.card table,
.card table th,
.card table td {
  background-color: #3a3a3a !important;
  color: #ffffff !important;
  border-color: #666 !important;
}

/* ‚úÖ Card ‡§Æ‡§ß‡•ç‡§Ø‡•á save section / div ‡§∏‡§æ‡§†‡•Ä */
.card div,
.card section {
  background-color: #3a3a3a !important;
  color: #ffffff !important;
}


/* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤‡§Æ‡§ß‡•ç‡§Ø‡•á table fields ‡§è‡§ï‡§æ‡§ñ‡§æ‡§≤‡•Ä ‡§è‡§ï */
@media(max-width:640px){
  table,
  thead,
  tbody,
  tr,
  th,
  td {
    display: block;
    width: 100% !important;
  }

  thead { display: none; }  /* mobile ‡§µ‡§∞ headings hide ‡§π‡•ã‡§§‡•Ä‡§≤ */
  
  tr { margin-bottom: 1rem; border: 1px solid #555; border-radius: .5rem; padding: .5rem; }
  
  td {
    text-align: left;
    padding: .5rem;
    position: relative;
    display: flex;
    flex-direction: column;
  }

  td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #bbb;
    margin-bottom: 4px;
  }
}


/* --- Input, Textarea, Select --- */
input, textarea, select {
    background: #4a4a4a;
    color: #ffffff;
    border: 1px solid #666;
    padding: .45rem;
    border-radius: .375rem;
    transition: border-color 0.2s, box-shadow 0.2s; /* Transition add kela */
}

/* Naveen code: Focus kelyavar effect */
input:focus, textarea:focus, select:focus {
  border-color: #0ea5e9; /* Blue border on focus */
  outline: none;
  box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3); /* Subtle blue glow */
}


/* Body - Background ani Font */
 body {
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
    /* #202020: Ajun ghadad (darker) background */
    background: #202020;
    color: #f0f0f0;        /* Thoda soft white font */
    line-height: 1.5;      /* Text madhe thodi jaaga */
  }

/* Container (Main Div) - Ek Udyat look */
.container {
    background-color: #2c2c2c; /* Container la background dya */
    padding: 1.5rem;
    border-radius: 1rem;       /* Thode jaast gol kinar */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Deep shadow */
    margin: 1.5rem auto;       /* Margin */
    max-width: 900px;
}



/* --- Tables (Sunder Alternating Rows) --- */
table {
    border-collapse: separate; /* Kinarasathi */
    border-spacing: 0 0.25rem; /* Rows madhe thodi jaaga */
    width: 100%;
}

/* Header row (Aadla Row) */
table th {
  background-color: #38bdf8 !important; /* Header la Sky Blue dya */
  color: #1f2937 !important; /* Dark text */
  padding: 0.75rem 0.5rem;
  font-weight: 700;
}
table th:first-child { border-top-left-radius: 0.5rem; }
table th:last-child { border-top-right-radius: 0.5rem; }


/* Data rows (Naveen Alternating look) */
table tbody tr {
    transition: background-color 0.2s;
    background-color: #333333; /* Default row color */
}

/* Joranchi raang (Even rows) */
table tbody tr:nth-child(even) {
  background-color: #3a3a3a !important; 
}

/* Ekdam uttam hover effect */
table tbody tr:hover {
    background-color: #4a4a4a !important; /* Hover kelyavar shine hoil */
    cursor: pointer;
}


/* Tumche Home, Estimates, Invoices sathi aslele div */
.tab-content, .panel {
    background-color: #2c2c2c; /* Background container chya color sarkha */
    padding: 1.2rem;
    border-radius: 0.75rem;
    border: 1px solid #3c3c3c; /* Subtle border */
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1); /* Inner shadow for depth */
    margin-bottom: 1rem;
}

/* --- Buttons (Smallbtn & Basic Button) --- */
.smallbtn, button:not(.smallbtn) {
    /* Existing styles thode badalun */
    background: #0ea5e9; /* Sky blue */
    color: #fff;
    border: none;
    padding: .5rem 1rem;
    border-radius: .5rem;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease-in-out; /* Smooth transition */
    
    /* 3D effect dya */
    box-shadow: 0 4px #0284c7; /* Darker blue shadow */
    transform: translateY(0);
}

/* Hover effect: Upar ya */
.smallbtn:hover, button:not(.smallbtn):hover {
    background: #38bdf8; /* Lighter blue on hover */
    box-shadow: 0 5px #0284c7; /* Shadow deep kara */
    transform: translateY(-2px); /* Button thoda var sarakel */
}

/* Click effect: Khali dabalya sarkha */
.smallbtn:active, button:not(.smallbtn):active {
    box-shadow: 0 2px #0284c7; /* Shadow kami kara */
    transform: translateY(2px); /* Button thoda khali dabla jael */
}


</style>
</head>
<body class="p-4 md:p-8">

<div class="nav">
  <div class="flex flex-1 overflow-x-auto whitespace-nowrap gap-2 py-1">
    <button class="smallbtn flex-shrink-0" onclick="show('home')">Home</button>
    <button class="smallbtn flex-shrink-0" onclick="show('est')">Estimates</button>
    <button class="smallbtn flex-shrink-0" onclick="show('inv')">Invoices</button>
    <button class="smallbtn flex-shrink-0" onclick="show('orders')">Orders</button>
    <button class="smallbtn flex-shrink-0" onclick="show('paid')">Paid Payments</button>
    <button class="smallbtn flex-shrink-0" onclick="show('exp')">Expenses</button>
    <button class="smallbtn flex-shrink-0" onclick="show('meas')">Measurements</button>
    <button class="smallbtn flex-shrink-0" onclick="show('daily')">Daily Reports</button>
    <button class="smallbtn flex-shrink-0" onclick="show('labor')">Labor Attendance</button>
    <button class="smallbtn flex-shrink-0" onclick="show('payments')">Payments</button>
    
  <div class="flex gap-2 items-center flex-shrink-0 mt-2 md:mt-0">
    <button onclick="exportToExcel()" class="smallbtn">Export Excel</button>
    <input type="file" accept=".xlsx" onchange="importFromExcel(event)" class="text-xs">
  </div>
  
  
  
</div>
  </div>
    <div class="w-full mt-2 md:mt-0 text-right md:text-center" style="font-weight:700">Welcome Vaibhav Enterprises</div>
</div>




<div id="home" class="tab-content" style="display:none"> 
    
    <div id="summary-cards" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div id="total-invoice-card" class="card-summary bg-blue-600">
            <p>Total Invoice</p>
            <h3 id="total-invoice-amount">‚Çπ 0</h3>
        </div>
        
        <div id="total-order-card" class="card-summary bg-yellow-600">
            <p>Expenses/Order</p>
            <h3 id="total-order-amount">‚Çπ 0</h3>
        </div>
        <div id="total-received-card" class="card-summary bg-teal-600">
            <p>Received Payment</p>
            <h3 id="total-received-amount">‚Çπ 0</h3>
        </div>
        <div id="total-paid-card" class="card-summary bg-red-600">
            <p>Paid Payment</p>
            <h3 id="total-paid-amount">‚Çπ 0</h3>
        </div>
        <div id="total-paid-card" class="card-summary bg-green-600">
  <p>All Profit</p>
  <h3 id="total-profit-amount">‚Çπ 0</h3>
</div>

</div>
    
    <div id="current-filter-display" class="mb-6 text-lg font-semibold text-center py-2 rounded-lg bg-gray-700">
        Current Filter: <span id="current-invoice-no" class="text-yellow-400">All Data</span>
    </div>
     
    <!-- üÜï Home Invoice Select Dropdown -->
<div class="mb-4 text-center">
  <label class="muted block mb-1 text-gray-300">Select Invoice</label>
  <select id="home-inv-select" class="p-2 border rounded w-64 text-black" onchange="updateHomeDashboard(this.value)">
    <option value="">-- Select Invoice --</option>
  </select>
</div>
   


    <div id="home-summary" class="mt-4">
      <h2 class="text-xl font-bold mb-4">Invoice-wise Expense & Profit</h2>
      <div id="invoice-summary" class="p-4 bg-gray-700 rounded text-white overflow-x-auto">
        <p class="text-center text-gray-400">Select an Invoice Number in the Expenses tab to see detailed summary here.</p>
      </div>
    </div>

    <div class="mt-6">
      <h2 class="text-xl font-bold mb-4">Expenses By Category</h2>
      <canvas id="categoryChart" height="200"></canvas>
    </div>
     </div>









<div id="est" class="card max-w-4xl mx-auto">
  <h2>Estimate</h2>
  <div class="grid md:grid-cols-3 gap-2">
    <div>
      <label class="muted">Estimate No</label>
      <input id="est-no" class="w-full" disabled>
    </div>
    <div>
      <label class="muted">Client Name</label>
      <input id="est-client" class="w-full">
    </div>
    <div>
      <label class="muted">Contact</label>
      <div class="flex gap-2">
        <input id="est-contact" class="w-full">
        <button class="smallbtn" type="button" onclick="pickContact('est')">üìû</button>
      </div>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-2 mt-2">
    <div>
      <label class="muted">Date</label>
      <input id="est-date" type="date" class="w-full">
    </div>
    <div>
      <label class="muted">Work Title</label>
      <input id="est-work" class="w-full">
    </div>
  </div>

  <div id="est-items" class="mt-3 space-y-2"></div>
  <div class="mt-2">
    <button class="smallbtn" type="button" onclick="addItem('est')">+ Add Item</button>
  </div>

  <div class="mt-3 flex justify-between items-center">
    <div class="muted">
      Discount (%) 
      <input type="number" id="est-discount" value="0" oninput="recalcAll()">

    </div>
     

    <div class="text-right">
      <div class="font-semibold">Subtotal: <span id="est-sub">0.00</span></div>
      <div class="font-semibold">Final Amount: <span id="est-total">0.00</span></div>
      <div class="muted">In words: <span id="est-words"></span></div>
    </div>
  </div>

  <div class="flex gap-2 mt-3">
    <button class="smallbtn" type="button" onclick="saveEstimate()">Save</button>
    <button class="smallbtn" type="button" onclick="exportEstimatePDF()">PDF</button>
    <button onclick="toggleSection('saved-est-list', this)" class="smallbtn mt-4">
  ‚ûï Show Saved Estimates
    </div>
    
<h3 class="mt-4 font-semibold">Saved Estimates</h3>
  <div id="saved-est-list" class="mt-2 space-y-2 hidden"></div>
  
</div>
 
 

  


<div id="inv" class="card max-w-4xl mx-auto" style="display:none">
  <h2>Invoice</h2>
  <div class="grid md:grid-cols-3 gap-2">
    <div><label class="muted">Invoice No</label><input id="inv-no" class="w-full" disabled></div>
    <div><label class="muted">Client Name</label><input id="inv-client" class="w-full"></div>
    <div><label class="muted">Contact</label><div class="flex gap-2"><input id="inv-contact" class="w-full"><button class="smallbtn" onclick="pickContact('inv')">üìû</button></div></div>
  </div>
  <div class="grid md:grid-cols-2 gap-2 mt-2">
    <div><label class="muted">Date</label><input id="inv-date" type="date" class="w-full"></div>
    <div><label class="muted">Work Title</label><input id="inv-work" class="w-full"></div>
  </div>

  <div id="inv-items" class="mt-3 space-y-2"></div>
  <div class="mt-2"><button class="smallbtn" onclick="addItem('inv')">+ Add Item</button></div>
 <div class="mt-2"></div>
  
  <div class="mt-3 flex justify-between items-center">
    <div class="muted">Advance (‚Çπ) <input id="inv-adv" type="number" value="0" class="ml-2 inline-block w-32 p-1 border rounded"></div>
    <div class="text-right">
      <div class="font-semibold">Subtotal: <span id="inv-sub">0.00</span></div>
      <div class="font-semibold">Final Amount: <span id="inv-total">0.00</span></div>
      <div class="muted">In words: <span id="inv-words"></span></div>
    </div>
  </div>

  <div class="flex gap-2 mt-3">
    <button class="smallbtn" onclick="saveInvoice()">Save</button>
    <button class="smallbtn" onclick="exportInvoicePDF()">PDF</button>
    <button onclick="toggleSection('saved-inv-list', this)" class="smallbtn mt-4">
  ‚ûï Show Saved Invoices
  </div>

  <h3 class="mt-4 font-semibold">Saved Invoices</h3>
  <div id="saved-inv-list" class="mt-2 space-y-2 hidden"></div>
  
</div>


  <div id="exp" class="card max-w-4xl mx-auto" style="display:none">
  <h2>Expenses</h2>

  <div class="grid md:grid-cols-2 gap-2 mb-3 items-end">
    <div>
      <label class="muted">Invoice (select)</label>
      <select id="exp-invoice-select" class="p-2 border rounded w-full"></select>
    </div>

    <div>
      <label class="muted">Main Category</label>
      <div class="flex gap-2">
        <select id="cat-select" class="p-2 border rounded flex-1"></select>
        <button class="smallbtn" onclick="addCategoryPrompt()">Add</button>
        <button class="smallbtn" onclick="deleteCategoryPrompt()">Delete</button>
      </div>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full border">
      <thead>
        <tr class="bg-gray-50">
          <th>Date</th><th>Item Name</th><th>Category</th>
        </tr>
        <tr class="bg-gray-50">
          <th>Qty</th><th>Unit</th><th>Rate</th><th>Amount</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="exp-rows"></tbody> </table>
  </div>

  <div class="mt-2 flex gap-2">
    <button class="smallbtn" onclick="addExpenseRow()">+ Add Item</button>
    <button class="smallbtn" onclick="saveExpenses()">Save</button>
    <button onclick="toggleSection('expenses-table-wrap', this)" class="smallbtn mt-4">
  ‚ûï Show Saved Expenses
  </div>

  <div class="mt-3 font-semibold">Total Expenses: ‚Çπ<span id="exp-total">0.00</span></div>

  <div id="expenses-table-wrap" class="overflow-x-auto hidden">
  <table class="w-full border">
    <thead>
      <tr class="bg-gray-50">
        <th>Date</th><th>Invoice No</th><th>Category</th><th>Items</th>
        <th>Qty</th><th>Unit</th><th>Rate</th><th>Amount</th><th>Action</th>
      </tr>
    </thead>
    <tbody id="expenses-tbody"></tbody> </table>
  </div>

  <div class="mt-4">
    <h3>Invoice-wise Profit</h3>
    <div id="invoice-profits" class="mt-2"></div>
  </div>
 
</div>




<div id="meas" class="card max-w-3xl mx-auto" style="display:none">
  <h2>Measurements</h2>

  <div class="grid md:grid-cols-2 gap-2 mb-2">
    
    <div>
      <label for="msr-client" class="block mb-1 font-medium">Customer Name</label>
      <input id="msr-client" placeholder="Customer Name" class="p-2 border w-full">
    </div>

    <div>
      <label for="msr-contact" class="block mb-1 font-medium">Customer Contact</label>
      <div class="flex gap-2">
        <input id="msr-contact" placeholder="Customer Contact" class="p-2 border flex-1">
        <button type="button" class="smallbtn" onclick="pickContact('msr')">üìû</button>
      </div>
    </div>

  </div>

  <div id="meas-items" class="space-y-2"></div>

  <div class="mt-2 flex items-center gap-2">
    <button class="smallbtn" onclick="addMeasurement()">+ Add Measurement</button>
    <button class="smallbtn" onclick="saveMeasurements()">Save</button>
    <button onclick="toggleSection('saved-meas', this)" class="smallbtn mt-4">
  ‚ûï Show Saved Measurements
    
  </div>
  <span id="meas-total" class="ml-4 font-semibold">Tot. R.ft: 0 | Tot. Sq.ft: 0</span>
  <h3 class="mt-4">Saved Measurements</h3>
  <div id="saved-meas" class="mt-2 hidden"></div>
  <input type="hidden" id="msr-id">
  
</div>



<!-- LABOR -->
<div id="labor" class="card max-w-4xl mx-auto" style="display:none">
  <h2>Labor Attendance</h2>

  <div class="flex gap-2 mb-2">
    <button class="smallbtn" onclick="addLabor()">+ New Labor</button>

    <input id="labor-search"
           class="p-2 border rounded flex-1"
           placeholder="Search by Client or Work"
           list="labor-suggestions"
           oninput="updateLaborSuggestions(this.value); filterLabor();">

    <datalist id="labor-suggestions"></datalist>

    <button class="smallbtn" onclick="exportLaborReport()">Report</button>
  </div>

  <div id="labor-rows" class="space-y-3"></div>
  <h3 class="mt-4">Saved Attendance</h3>
  <div id="saved-labor" class="mt-2"></div>
</div>





<div id="payments" class="card max-w-4xl mx-auto" style="display:none">
  <h2>Recive Payments</h2>
  <div class="grid md:grid-cols-4 gap-2">
   
  <select id="pay-invno" class="p-2 border rounded w-full" onchange="handleInvoiceSelectInPayment(this.value)">
  <option value="">Select Invoice</option>
  </select>

    
    <div><label class="muted">Client Name</label><input id="pay-client" class="w-full"></div>
    <div><label class="muted">Contact</label><div class="flex gap-2"><input id="pay-contact" class="w-full"><button class="smallbtn" onclick="pickContact('pay')">Pick</button></div></div>
    <div><label class="muted">Work Title</label><input id="pay-work" class="w-full"></div>
    <div><label class="muted">Project Cost (‚Çπ)</label><input id="pay-cost" type="number" class="w-full"></div>
  </div>

  <div id="payment-rows" class="mt-3 space-y-2"></div>
  <div class="mt-2"><button class="smallbtn" onclick="addPaymentRowForm()">+ Add Payment Entry</button> <button class="smallbtn" onclick="savePayments()">Save Payments</button></div>
  <button onclick="toggleSection('saved-payments', this)" class="smallbtn mt-4">
  ‚ûï Show Saved Payments
</button> 
  <h3 class="mt-4">Saved Payments</h3>
  <div id="saved-payments" class="mt-2 hidden"></div>
  
</div>



<div id="orders" class="card max-w-4xl mx-auto" style="display:none">
  <h2>Orders</h2>

  <select id="order-invoice-select" class="p-2 border rounded w-full">
  <option value="">-- Select Invoice No --</option>
</select>


   <div class="mb-2">
    <label class="muted">Client Name</label>
    <input id="ord-client" type="text" class="w-full p-2 border rounded">
 </div>

  <div class="mb-2">
    <label class="muted">Work</label>
    <input id="ord-work" type="text" class="w-full p-2 border rounded">
  </div>

  <div class="mb-2">
    <label class="muted">Date</label>
    <input id="ord-date" type="date" class="w-full p-2 border rounded">
  

  

<label class="block mt-2">Order Status</label>
<select id="order-status" class="p-2 border rounded w-full">
  <option value="">-- Select Status --</option>
  <option value="order">Order</option>
  <option value="received">Order Received</option>
  <option value="cancelled">Order Cancelled</option>
  <option value="returned">Order Returned</option>
</select>

<div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px;">
  <input type="text" id="merchant-name" placeholder="Merchant Name" />

  <input type="tel" id="merchant-contact" placeholder="Contact No." />

  <select id="payment-status" style="flex: 1.5; min-width: 120px;">
  <option value="" disabled selected>Select Status</option>
  <option value="Order">Order</option>
  <option value="Paid">Paid</option>
  <option value="Unpaid">Unpaid</option>
</select>
  <button onclick="pickContact('ord')">üìû</button>
</div>


</div>
  


  <div id="order-items" class="space-y-2"></div>

  <div class="mt-2 flex gap-2">
    <button class="smallbtn" onclick="addOrderRow()">+ Add Item</button>
    <button class="smallbtn" onclick="saveOrder()">Save Order</button>
    <button class="smallbtn" onclick="importMaterialList()">Import Items</button>
 

  </div>
   
   <button onclick="toggleSection('saved-orders', this)" class="smallbtn mt-4">
  ‚ûï Show Saved Orders
</button>
 
  <div class="flex gap-2 justify-end mt-3">
    
  </div>

  <h4 class="mt-4 font-semibold">Saved Orders</h4>
  <div id="saved-orders" class="mt-2 space-y-2 hidden"></div>
  <datalist id="material-list"></datalist>
  <datalist id="materials"></datalist>
  
</div>



<div id="paid" class="card max-w-4xl mx-auto" style="display:none">
 <h2>Paid Payment</h2>
<div class="grid grid-cols-2 gap-2 mb-2">
  <div>
    <label class="muted">Invoice No</label>
    <select id="pp-invno" class="p-2 border rounded w-full" onchange="handleInvoiceSelectInPaid(this.value)">
      <option value="">Select Invoice</option>
    </select>
  </div>

  <div>
    <label class="muted">Order ID</label>
    <select id="pp-order-id" class="p-2 border rounded w-full">
      <option value="">-- Select Order ID --</option>
    </select>
  </div>
</div>


  <div class="mb-2">
    <label class="muted">Client Name</label>
    <input id="pp-client" type="text" class="w-full p-2 border rounded">
  </div>

  <div class="mb-2">
    <label class="muted">Work</label>
    <input id="pp-work" type="text" class="w-full p-2 border rounded">
  </div>

  <div class="grid grid-cols-2 gap-2 mb-2">
    <div>
      <label class="muted">Name</label>
      <input id="pp-name" placeholder="labor/Contractor/Marchant Name" class="p-2 border rounded w-full">
    </div>
    <div>
      <label class="muted">Labor / Contractort </label>
      <input id="pp-labor" placeholder="Work by" class="p-2 border rounded w-full">
    </div>
  </div>

  <div id="pp-rows" class="space-y-2"></div>
  <button class="smallbtn mt-2" onclick="addPaidRow()">+ Add Payment</button>
  <button class="smallbtn" onclick="savePaidPayment()">Save</button>
  <div class="flex gap-2 justify-end mt-3">
    
  </div>
  <button onclick="toggleSection('saved-paid', this)" class="smallbtn mt-4">
  ‚ûï Show Saved Payments
</button>
  <h4 class="mt-4 font-semibold">Saved Paid Payments</h4>
  <div id="saved-paid" class="mt-2 space-y-2 hidden"></div>
  <input type="hidden" id="pp-id">
</div>







<div id="daily" class="card max-w-4xl mx-auto" style="display:none">
  <h2>Daily Report</h2>

  <div class="grid md:grid-cols-3 gap-2 mb-2">
    <input id="dr-client" placeholder="Client Name" class="p-2 border rounded">
    <input id="dr-contact" placeholder="Contact" class="p-2 border rounded">
    <input id="dr-work" placeholder="Work Title" class="p-2 border rounded">
  </div>

  <div id="daily-rows" class="space-y-2"></div>

  <div class="mt-2 flex gap-2">
    <button class="smallbtn" onclick="addDailyRow()">+ Add Row</button>
    <button class="smallbtn" onclick="saveDaily()">Save</button>
    <button onclick="toggleSection('saved-daily', this)" class="smallbtn mt-4">
  ‚ûï Show Saved Reports
</div>

<h3 class="mt-4">Saved Reports</h3>
  <div id="saved-daily" class="mt-2 hidden"></div>
  </div>

<footer class="w-full mt-2 text-center muted">¬© Application Developed Vaibhav enterprises</footer>






<script>

/* -------------------------------------------------------------
 * üö© LOCAL STORAGE DATA MODEL & CORE FUNCTIONS
 * ------------------------------------------------------------- */
const KEY = 've_final_v1';
let DATA = {
  estimates: [], 
  invoices: [], 
  expenses: [], 
  measurements: [], 
  daily: [], 
  labor: [], 
  payments: [], 
  orders: [],        // ‚úÖ New
  paidPayments: [],  // ‚úÖ New
  categories: ["Material", "Labor", "Transport", "Miscellaneous"], // Default categories
  materials: [],
  counters: { est:0, inv:0, exp:0, meas:0, pay:0, lab:0, ord:0, pp:0 } // ‚úÖ Updated counters
};

function loadData(){ 
  const s = localStorage.getItem(KEY); 
  if(s) DATA = JSON.parse(s); 
  // Ensure default structures are present if data is new or partial
  DATA.categories = DATA.categories || ["Material", "Labor", "Transport", "Miscellaneous"];
  DATA.counters = DATA.counters || { est:0, inv:0, exp:0, meas:0, pay:0, lab:0, ord:0, pp:0 };
  DATA.orders = DATA.orders || [];
  DATA.paidPayments = DATA.paidPayments || [];

  renderAll(); 
}

function saveData(){ 
  localStorage.setItem(KEY, JSON.stringify(DATA)); 
  renderAll(); // Rerender all lists and summaries after saving

  // Firestore ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§∏‡•Å‡§¶‡•ç‡§ß‡§æ save ‡§ï‡§∞‡§£‡•á (availability check)
  try {
    if (typeof saveToFirestore === 'function') {
      saveToFirestore();
    }
  } catch(e) { console.warn("Firestore save skipped:", e); }
}



// ‚úÖ Universal Company Info Fetcher
function getCompanyInfo() {
  const c = (DATA.company || {});
  return {
    name: c.name || "Vaibhav Enterprises",
    contact: c.contact || "9049764945",
    website: c.website || "www.vaibhaventerprises.info",
    regNo: c.regNo || "MH-26-0106699",
    address: c.address || "Kolhapur"
  };
}

/* ===========================
   ‚úÖ ONE-TIME COMPANY SETUP
   =========================== */

function generateActivationToken() {
  return String(Math.floor(100000 + Math.random() * 900000));
}

// ‚úÖ GOOGLE SCRIPT EMAIL SENDER
function sendActivationEmail(company, token) {
  const payload = {
    company_name: company.name,
    contact: company.contact,
    email: company.email,
    website: company.website,
    regNo: company.regNo,
    address: company.address,
    activation_code: token
  };

fetch("https://script.google.com/macros/s/AKfycbwe1SMdBNdj0kSmP5y8xI1Nj-rduYFOzG-ZppzNh4GrTHp7faGVC0txgVmLriInGGLw/exec", {
  method: "POST",
  mode: "no-cors", // üß© ‡§π‡•á ‡§ú‡•ã‡§°‡§æ!
  body: JSON.stringify(payload),
  headers: { "Content-Type": "application/json" },
})
.then(() => {
  alert("‚úÖ ‡§à‡§Æ‡•á‡§≤ ‡§™‡§æ‡§†‡§µ‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§µ‡§ø‡§®‡§Ç‡§§‡•Ä Vaibhav Enterprise's ‡§ï‡§°‡•á ‡§ó‡•á‡§≤‡•Ä ‡§Ü‡§π‡•á.\n‡§ï‡§æ‡§π‡•Ä ‡§∏‡•á‡§ï‡§Ç‡§¶‡§æ‡§Ç‡§®‡•Ä Gmail ‡§§‡§™‡§æ‡§∏‡§æ.");
})
.catch(err => {
  console.error("‚ùå Error:", err);
  alert("‚ùå ‡§à‡§Æ‡•á‡§≤ ‡§™‡§æ‡§†‡§µ‡§£‡•ç‡§Ø‡§æ‡§§ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä.\n‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.");
});

}

function saveCompanyData(company) {
  DATA.company = company;
  localStorage.setItem("APP_COMPANY_DATA", JSON.stringify(company));
  saveData();
}

function loadCompanyData() {
  try {
    const data = localStorage.getItem("APP_COMPANY_DATA");
    if (data) DATA.company = JSON.parse(data);
  } catch (e) {
    console.warn("Company data load error", e);
  }
}

function openCompanyModal(existing = {}) {
  const modal = document.createElement("div");
  modal.id = "company-setup-modal";
  modal.style = `
    position:fixed; inset:0; background:rgba(0,0,0,0.6);
    display:flex; align-items:center; justify-content:center; z-index:99999;
  `;

    modal.innerHTML = `
    <div class="max-w-xl w-full bg-slate-900 text-white p-6 rounded-xl shadow-2xl">
      <h2 class="text-2xl font-bold mb-2">Welcome ‚Äî Company Setup</h2>
      <p class="text-slate-400 mb-4">Fill company details once. After verification, this won't appear again.</p>

      <!-- ‚úÖ BADAL ITHE KELA: grid-cols-1 for mobile, md:grid-cols-2 for desktop -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> 
        <input id="cs-name" placeholder="Company Name" value="${existing.name||''}" class="cs-inp p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-sky-500 focus:border-sky-500">
        <input id="cs-contact" placeholder="Contact No" value="${existing.contact||''}" class="cs-inp p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-sky-500 focus:border-sky-500">
        <input id="cs-email" placeholder="Email (required)" value="${existing.email||''}" class="cs-inp p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-sky-500 focus:border-sky-500">
        <input id="cs-website" placeholder="Website" value="${existing.website||''}" class="cs-inp p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-sky-500 focus:border-sky-500">
        <input id="cs-reg" placeholder="Company Registration No" value="${existing.regNo||''}" class="cs-inp p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-sky-500 focus:border-sky-500">
        <input id="cs-address" placeholder="Address" value="${existing.address||''}" class="cs-inp p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-sky-500 focus:border-sky-500">
      </div>

      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <button id="cs-send" class="smallbtn bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out w-full sm:w-auto">Send to Owner</button>
        <button id="cs-verify" class="smallbtn bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out w-full sm:w-auto">Enter Code</button>
      </div>

      <div id="verify-box" class="mt-4 hidden items-center gap-3">
        <input id="verify-input" placeholder="Enter 6-digit code" class="cs-inp p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-sky-500 focus:border-sky-500 w-full sm:w-48">
        <button id="verify-btn" class="smallbtn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">Verify</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  const token = generateActivationToken();
  console.log("üîë Owner Activation Code:", token);

  localStorage.setItem("APP_PENDING_TOKEN", token);

  const sendBtn = modal.querySelector("#cs-send");
  const verifyBtn = modal.querySelector("#cs-verify");
  const confirmBtn = modal.querySelector("#verify-btn");

  sendBtn.onclick = () => {
    const company = {
      name: val("cs-name"),
      contact: val("cs-contact"),
      email: val("cs-email"),
      website: val("cs-website"),
      regNo: val("cs-reg"),
      address: val("cs-address"),
    };
    if (!company.email) return alert("Please enter Email.");

    // Save pending data locally
    localStorage.setItem("APP_PENDING_COMPANY", JSON.stringify(company));

    // Generate one single token
    const token = generateActivationToken();
    localStorage.setItem("APP_PENDING_TOKEN", token);

    // üìß ‡§´‡§ï‡•ç‡§§ ‡§à‡§Æ‡•á‡§≤ ‡§™‡§æ‡§†‡§µ‡§æ
    sendActivationEmail(company, token);
  };

  verifyBtn.onclick = () => {
    document.getElementById("verify-box").style.display = "block";
  };

  confirmBtn.onclick = () => {
    const input = val("verify-input");
    const expected = localStorage.getItem("APP_PENDING_TOKEN");
    if (input !== expected) return alert("Invalid code!");
    const company = JSON.parse(localStorage.getItem("APP_PENDING_COMPANY") || "{}");
    company.activated = true;
    saveCompanyData(company);
    localStorage.removeItem("APP_PENDING_COMPANY");
    localStorage.removeItem("APP_PENDING_TOKEN");
    alert("‚úÖ Verified! Company data saved permanently.");
    applyCompanyToUI();
    //modal.remove();
    location.reload();
};
}

function val(id){ return (document.getElementById(id)?.value || "").trim(); }

function applyCompanyToUI(){
  if(!DATA.company) return;
  const {name,contact,website,regNo,address} = DATA.company;
  try{
    let html=document.body.innerHTML;
    if(name) html=html.replace(/Vaibhav Enterprises/g,name);
    if(contact) html=html.replace(/9049764945/g,contact);
    if(website) html=html.replace(/www.vaibhaventerprises.info/g,website);
    if(regNo) html=html.replace(/MH-26-0106699/g,regNo);
    if(address) html=html.replace(/Kolhapur/g,address);
    document.body.innerHTML=html;
  }catch(e){console.warn("applyCompanyToUI skip",e);}
}



function initCompanyRegistration(){
  loadCompanyData();
  
  if(DATA.company && DATA.company.activated){
    applyCompanyToUI();
    return;
  }
  openCompanyModal(DATA.company || {});
}

initCompanyRegistration();








function renderAll() {
  renderEstimatesList();
  renderInvoicesList();
  renderExpensesList();
  renderMeasurementsList();
  renderOrders(); 
  renderPaymentsList();
  renderPaidPayments();
  renderDailyReports();
  
  populateInvoiceSelects(); // Important for all connected modules
  updateHomeSummary();
  renderCategorySelect();
  renderInvoiceProfits();
  renderExpensesChart();
 renderMaterialsDropdown();
 populateHomeInvoices(); // ‚úÖ Home invoice dropdown refresh


// --- Labor ---
  const sl = el('saved-labor');
  sl.innerHTML = '';
  DATA.labor.forEach(l => {
    const div = document.createElement('div');
    div.className = 'p-2 bg-gray-50 rounded flex justify-between items-center';
    div.innerHTML = `<div><strong>${l.id}</strong> ${l.name} (${l.start} to ${l.end})</div><div class="flex gap-2"><button class="smallbtn" onclick="loadLabor('${l.id}')">Load</button><button class="smallbtn" onclick="shareLabor('${l.id}')">Share</button><button class="smallbtn" onclick="deleteLabor('${l.id}')">Delete</button></div>`;
    sl.appendChild(div);
  });


}


/* -------------------------------------------------------------
 * üõ†Ô∏è UTILITY & UI HELPERS
 * ------------------------------------------------------------- */

function show(id) {
  // Hide all tab-content sections (including home, estimate, etc.)
  document.querySelectorAll('.tab-content, .card').forEach(c => c.style.display = 'none');

  // Show only the selected section
  const elToShow = document.getElementById(id);
  if (elToShow) elToShow.style.display = 'block';

  // Scroll to top for better UX
  window.scrollTo({ top: 0, behavior: 'smooth' });
}



function el(id){ return document.getElementById(id); }
function money(n){ return (parseFloat(n)||0).toFixed(2); }

function toggleSection(sectionId, btn) { 
  const sec = document.getElementById(sectionId); 
  const isHidden = sec.classList.contains("hidden"); 
  if (isHidden) { 
    sec.classList.remove("hidden"); 
    btn.innerText = "‚ûñ Hide Saved Data"; 
  } else { 
    sec.classList.add("hidden"); 
    btn.innerText = "‚ûï Show Saved Data"; 
  } 
}

function formatDateToInput(dateString) {
    if (!dateString) return '';
    try {
        const d = new Date(dateString);
        if (isNaN(d)) return String(dateString).slice(0, 10);
        return d.toISOString().split('T')[0];
    } catch (e) {
        return String(dateString).slice(0, 10);
    }
}


function refreshMaterialsDatalist() {
  const dl = document.getElementById('material-list');
  if (!dl) return;
  dl.innerHTML = '';
  (DATA.materials || []).forEach(mat => {
    const opt = document.createElement('option');
    opt.value = mat.part;
    dl.appendChild(opt);
  });
}



/* ---------- Contact picker (fallback prompt) ---------- */
function pickContact(form){
  try{
    if('contacts' in navigator && navigator.contacts.select){
      navigator.contacts.select(['name','tel'], {multiple:false}).then(list=>{
        if(list && list.length){
          const c = list[0];
          const name = (c.name && c.name[0])||'';
          const tel = (c.tel && c.tel[0])||'';

          if(form==='est'){ el('est-client').value = name; el('est-contact').value = tel; }
          if(form==='inv'){ el('inv-client').value = name; el('inv-contact').value = tel; }
          if(form==='pay'){ el('pay-client').value = name; el('pay-contact').value = tel; }
          if(form==='msr'){ el('msr-client').value = name; el('msr-contact').value = tel; }
          if(form==='ord'){ el('merchant-name').value = name; el('merchant-contact').value = tel; } 
        }
      }).catch(e=>{ fallbackPrompt(); });
      return;
    }
  }catch(e){}
  fallbackPrompt();

  function fallbackPrompt(){
    const name = prompt('Contact name');
    const tel = prompt('Contact number');
    if(!name && !tel) return;

    if(form==='est'){ if(name) el('est-client').value=name; if(tel) el('est-contact').value=tel; }
    if(form==='inv'){ if(name) el('inv-client').value=name; if(tel) el('inv-contact').value=tel; }
    if(form==='pay'){ if(name) el('pay-client').value=name; if(tel) el('pay-contact').value=tel; }
    if(form==='msr'){ if(name) el('msr-client').value=name; if(tel) el('msr-contact').value=tel; }
    if(form==='ord'){ if(name) el('merchant-name').value=name; if(tel) el('merchant-contact').value=tel; } 
  }
}

/* -------------------------------------------------------------
 * üìà HOME SUMMARY / REPORTING
 * ------------------------------------------------------------- */

function getInvoiceTotal(invoices) {
    return invoices.reduce((sum, inv) => sum + (parseFloat(inv.grandTotal) || 0), 0);
}

function getExpenseTotal(expenses) {
    return expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
}

function getReceivedTotal(payments) {
    return payments.reduce((sum, pay) => sum + (parseFloat(pay.received) || 0), 0);
}

function getPaidPaymentsTotal(paidPayments) {
    return paidPayments.reduce((sum, pp) => sum + (parseFloat(pp.amount) || 0), 0);
}

function updateHomeSummary() {
  const invoiceTotal = getInvoiceTotal(DATA.invoices);
  const expenseTotal = getExpenseTotal(DATA.expenses);
  const receivedTotal = getReceivedTotal(DATA.payments);
  const paidPaymentTotal = getPaidPaymentsTotal(DATA.paidPayments); 
  const profitTotal = invoiceTotal - expenseTotal;

  // Output
  const totalInvEl = el('total-invoice-amount');
  const totalOrderEl = el('total-order-amount');
  const totalReceivedEl = el('total-received-amount');
  const totalPaidEl = el('total-paid-amount');
  const totalProfitEl = el('total-profit-amount');
  
  if (totalInvEl) totalInvEl.textContent = "‚Çπ " + invoiceTotal.toFixed(2);
  if (totalOrderEl) totalOrderEl.textContent = "‚Çπ " + expenseTotal.toFixed(2);
  if (totalReceivedEl) totalReceivedEl.textContent = "‚Çπ " + receivedTotal.toFixed(2);
  if (totalPaidEl) totalPaidEl.textContent = "‚Çπ " + paidPaymentTotal.toFixed(2);
  if (totalProfitEl) totalProfitEl.textContent = "‚Çπ " + profitTotal.toFixed(2);
}


/* ---------- Number to Words (Indian Rupees) ---------- */
function numberToWords(amount){
    amount = Math.round(amount);
    if(isNaN(amount)) return '';
    if(amount === 0) return 'Zero Rupees Only';
    const ones = ["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine",
                  "Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen",
                  "Seventeen","Eighteen","Nineteen"];
    const tens = ["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];
    
    function convert_hundreds(num){
        let str = "";
        if(num > 99){ str += ones[Math.floor(num/100)] + " Hundred "; num = num % 100; }
        if(num > 19){ str += tens[Math.floor(num/10)] + " "; num = num % 10; }
        if(num > 0){ str += ones[num] + " "; }
        return str.trim();
    }

    function convert_to_words(num){
        if(num === 0) return "";
        let result = "";
        const crore = Math.floor(num / 10000000);
        if(crore > 0){ result += convert_hundreds(crore) + " Crore "; num %= 10000000; }
        const lakh = Math.floor(num / 100000);
        if(lakh > 0){ result += convert_hundreds(lakh) + " Lakh "; num %= 100000; }
        const thousand = Math.floor(num / 1000);
        if(thousand > 0){ result += convert_hundreds(thousand) + " Thousand "; num %= 1000; }
        const hundred = Math.floor(num / 100);
        if(hundred > 0){ result += convert_hundreds(hundred*100); num %= 100; }
        if(num > 0){ result += convert_hundreds(num); }
        return result.trim();
    }
    return convert_to_words(amount) + " Rupees Only";
}

/* ---------- Items (for estimate/invoice) ---------- */
function addItem(prefix, data = {}) {
    const container = document.getElementById(prefix + '-items');
    const row = document.createElement('div');
    row.className = "item-row border rounded p-3 flex flex-col gap-2 bg-white";

    const qty = Number(data.quantity || data.qty || 0);
    const rate = Number(data.rate || 0);
    const amount = qty * rate;

    row.innerHTML = `
        <div class="flex items-center">
            <input type="text" class="item-name flex-1 p-2 border rounded" list="material-list" placeholder="Item" value="${data.name || ''}">
            <button type="button" class="smallbtn ml-2 bg-red-500 text-white" onclick="this.closest('.item-row').remove(); recalcAll()">‚úï</button>
        </div>
        <textarea class="item-desc w-full p-2 border rounded" placeholder="Description (long answer)">${data.description || data.desc || ''}</textarea>
        <div class="grid grid-cols-4 gap-2">
            <input type="number" class="item-qty p-2 border rounded" placeholder="Qty" value="${qty}" oninput="recalcAll()" min="0">
            <input type="text" class="item-unit p-2 border rounded" placeholder="Unit" value="${data.unit || ''}">
            <input type="number" class="item-rate p-2 border rounded" placeholder="Rate" value="${rate}" oninput="recalcAll()" min="0">
            <input type="number" class="item-amt p-2 border rounded bg-gray-600 text-white" placeholder="Amount" value="${amount.toFixed(2)}" disabled>
        </div>
    `;
    container.appendChild(row);

    // Qty * Rate calculation
    const qtyInput = row.querySelector('.item-qty');
    const rateInput = row.querySelector('.item-rate');
    const amtInput = row.querySelector('.item-amt');

    [qtyInput, rateInput].forEach(i => i.addEventListener('input', () => {
        const q = parseFloat(qtyInput.value) || 0;
        const r = parseFloat(rateInput.value) || 0;
        amtInput.value = (q * r).toFixed(2);
        recalcAll();
    }));

    // Unit auto-fill on item select
    const partInput = row.querySelector('.item-name');
    partInput.addEventListener('change', () => {
        const match = (DATA.materials || []).find(m => m.part === partInput.value);
        if (match && match.unit) {
            row.querySelector('.item-unit').value = match.unit;
        }
    });

    recalcAll();
}

/* ---------- Recalc totals ---------- */
function recalcAll() {
    // -------- Estimate ----------
    let estSub = 0;
    document.querySelectorAll('#est-items .item-row').forEach(row => {
        const qty = Number(row.querySelector('.item-qty')?.value) || 0;
        const rate = Number(row.querySelector('.item-rate')?.value) || 0;
        const amt = qty * rate;
        if (row.querySelector('.item-amt')) row.querySelector('.item-amt').value = amt.toFixed(2);
        estSub += amt;
    });

    const discountPercent = Number(el('est-discount')?.value) || 0;
    const discountAmt = estSub * (discountPercent / 100);
    const estTotal = estSub - discountAmt;

    if (el('est-sub')) el('est-sub').textContent = estSub.toFixed(2);
    if (el('est-total')) el('est-total').textContent = estTotal.toFixed(2);
    if (el('est-words')) el('est-words').textContent = numberToWords(estTotal) + " only";

    // ---------- Invoice ----------
    let invSub = 0;
    document.querySelectorAll('#inv-items .item-row').forEach(row => {
        const qty = Number(row.querySelector('.item-qty')?.value) || 0;
        const rate = Number(row.querySelector('.item-rate')?.value) || 0;
        const amt = qty * rate;
        if (row.querySelector('.item-amt')) row.querySelector('.item-amt').value = amt.toFixed(2);
        invSub += amt;
    });

    const invAdv = Number(el('inv-adv')?.value) || 0;
    // Invoice final amount logic: Total - Advance (for display)
    const invTotalDisplay = Math.max(0, invSub - invAdv);
    
    if (el('inv-sub')) el('inv-sub').textContent = money(invSub);
    if (el('inv-total')) el('inv-total').textContent = money(invTotalDisplay); // Display Total-Advance
    if (el('inv-words')) el('inv-words').textContent = numberToWords(invTotalDisplay) + " only";
    
    renderInvoiceProfits();
}


/* -------------------------------------------------------------
 * 1Ô∏è‚É£ ESTIMATE (Local Storage Implementation)
 * ------------------------------------------------------------- */

function clearEstimateForm() {
    el('est-no').value = '';
    el('est-client').value = '';
    el('est-contact').value = '';
    el('est-date').value = new Date().toISOString().slice(0, 10);
    el('est-work').value = '';
    el('est-discount').value = '0';
    el('est-items').innerHTML = '';
    recalcAll();
   
}

// ‚úÖ Google Sheet ‡§Æ‡§ß‡•Ç‡§® ‡§™‡•Å‡§¢‡§ö‡§æ Estimate No ‡§Ü‡§£‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä function
async function generateNextEstimateNo() {
  try {
    const res = await fetch(`${DEPLOY_URL}?action=getnextno`);
    const nextNo = parseInt(await res.text()) || 1;
    const estNo = "EST-" + nextNo.toString().padStart(4, "0");
    el("est-no").value = estNo;
    console.log("Next Estimate No from Sheet:", estNo);
    return estNo;
  } catch (err) {
    console.error("‚ö†Ô∏è Failed to fetch next Estimate No:", err.message);
    // fallback ‚Äî LocalStorage ‡§µ‡§∞‡•Ç‡§® ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ
    return generateAvailableEstimateNo();
  }
}



const DEPLOY_URL = "https://script.google.com/macros/s/AKfycbzqfYitlp6Nm1RxFtOVlhBSWHn5vAh3fw7xnijJWJF1dISUozPwRhn4bZZP3Lm82a7_/exec";

 async function saveEstimate() {

    const items = [];
    el('est-items').querySelectorAll('.item-row').forEach(div => {
        const name = div.querySelector('.item-name').value;
        if (!name) return;
        const qty = Number(div.querySelector('.item-qty').value) || 0;
        const rate = Number(div.querySelector('.item-rate').value) || 0;
        
        items.push({ 
            name, 
            unit: div.querySelector('.item-unit').value,
            quantity: qty,
            rate: rate,
            description: div.querySelector('.item-desc').value || '',
            total: qty * rate
        });
    });

    if (!items.length) {
        return alert("Please add at least one item.");
    }

    const subtotal = items.reduce((sum, it) => sum + it.total, 0);
    const discountPercent = Number(el('est-discount').value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const grandTotal = subtotal - discountAmount;
    
    let estNo = el('est-no').value;
    
if (!estNo || !estNo.startsWith('EST-')) {
  estNo = await generateNextEstimateNo();
  el('est-no').value = estNo;
}


    const rec = {
        id: estNo,
        client: el('est-client').value || '',
        contact: el('est-contact').value || '',
        date: el('est-date').value || new Date().toISOString().slice(0, 10),
        work: el('est-work').value || '',
        items: items,
        subtotal: subtotal.toFixed(2),
        discount: discountPercent.toFixed(2),
        grandTotal: grandTotal.toFixed(2),
        status: "Pending"
    };

    const existingIndex = DATA.estimates.findIndex(e => e.id === estNo);
    if (existingIndex !== -1) {
        DATA.estimates[existingIndex] = rec;
        alert("Estimate updated: " + estNo);
    } else {
        DATA.estimates.push(rec);
        // Ensure the counter is advanced if a new ID was used
        const currentCounter = parseInt(estNo.replace('EST-', '')) || 0;
        if (currentCounter >= DATA.counters.est) {
            DATA.counters.est = currentCounter + 1;
        }
        alert("Estimate saved: " + estNo);
    }

    saveData();
    clearEstimateForm();
 
/* ‚úÖ Google Sheet ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§¶‡•á‡§ñ‡•Ä‡§≤ save ‡§ï‡§∞‡§æ */
try {
  const recForSheet = {
    "Customer Name": rec.client,
    "Customer Whatsapp": rec.contact,
    "Date": rec.date,
    "Work Title": rec.work,
    "Estimate Number": rec.id,
    "Items": JSON.stringify(rec.items),
    "Subtotal": rec.subtotal,
    "Discount": rec.discount,
    "Grand Total": rec.grandTotal,
    "Status": rec.status,
    "Your WhatsApp Number": "9049764945"
  };

  const res = await fetch(`${DEPLOY_URL}?action=save&data=${encodeURIComponent(JSON.stringify(recForSheet))}`, {
    method: "POST",
  });

  const out = await res.json();
  if (out.status === "success") {
    console.log("‚úÖ Saved to Google Sheet: " + rec.id);
  } else {
    console.warn("‚ùå Sheet Save Error:", out.message);
  }
} catch (err) {
  console.error("‚ö†Ô∏è Google Sheet Save Failed:", err.message);
}

}


/* ---------- LOAD ESTIMATES FROM GOOGLE SHEET ---------- */
async function syncEstimatesFromSheet() {
  const DEPLOY_URL = "https://script.google.com/macros/s/AKfycbzqfYitlp6Nm1RxFtOVlhBSWHn5vAh3fw7xnijJWJF1dISUozPwRhn4bZZP3Lm82a7_/exec";
  try {
    const res = await fetch(`${DEPLOY_URL}?action=getall`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      console.warn("No estimates found in Sheet.");
      return;
    }

    // üß© Convert Sheet Data ‚Üí Local Format
    const converted = data.map(row => ({
      id: row["Estimate Number"] || "",
      client: row["Customer Name"] || "",
      contact: row["Customer Whatsapp"] || "",
      date: row["Date"] || "",
      work: row["Work Title"] || "",
      items: (() => {
        try { return JSON.parse(row["Items"] || "[]"); } catch { return []; }
      })(),
      subtotal: row["Subtotal"] || "0",
      discount: row["Discount"] || "0",
      grandTotal: row["Grand Total"] || "0",
      status: row["Status"] || "Pending"
    }));

    // üß† Merge with Local DATA.estimates
    DATA.estimates = converted;
    saveData(); // save to localStorage
    renderEstimatesList(); // refresh UI
    console.log(`‚úÖ Synced ${converted.length} estimates from Sheet.`);
  } catch (err) {
    console.error("‚ùå Failed to sync estimates:", err);
  }
}



function renderEstimatesList() {
    const box = el('saved-est-list');
    if (!box) return;
    box.innerHTML = '';

    (DATA.estimates || []).sort((a, b) => b.id.localeCompare(a.id)).forEach(e => {
        const div = document.createElement('div');
        div.className = 'p-2 bg-gray-700 rounded flex flex-wrap justify-between items-center text-sm mb-1';
        div.innerHTML = `
            <div class="flex-1 min-w-[200px]">
                <strong>${e.id}</strong> (${e.date}) - ${e.client || 'N/A'} | ‚Çπ${e.grandTotal}
            </div>
            <div class="flex gap-2 mt-2 md:mt-0">
                <button class="smallbtn" onclick="loadRecord('${e.id}')">üîÉ</button>
                <button class="smallbtn" onclick="shareEstimate('${e.id}')">üîÄ</button>
                <button class="smallbtn bg-red-500" onclick="deleteEstimate('${e.id}')">X</button>
            </div>
        `;
        box.appendChild(div);
    });
}

window.loadRecord = function(estNo) {
    const rec = DATA.estimates.find(e => e.id === estNo);
    if (!rec) {
        alert("Record not found: " + estNo);
        return;
    }
    show('est');
    el('est-no').value = rec.id || '';
    el('est-client').value = rec.client || '';
    el('est-contact').value = rec.contact || '';
    el('est-date').value = formatDateToInput(rec.date);
    el('est-work').value = rec.work || '';
    el('est-discount').value = rec.discount || '0';
    
    const container = el('est-items');
    container.innerHTML = '';
    (rec.items || []).forEach(it => {
        addItem('est', it); // addItem takes data object
    });
    recalcAll();
};

// ---------- DELETE ESTIMATE (Local + Google Sheet) ----------
async function deleteEstimate(estNo) {
  if (!confirm("Delete this estimate?")) return;

  // 1Ô∏è‚É£ Local Storage ‡§Æ‡§ß‡•Ç‡§® delete ‡§ï‡§∞‡§æ
  DATA.estimates = DATA.estimates.filter(e => e.id !== estNo);
  saveData();
  renderEstimatesList();
  alert("Estimate deleted locally: " + estNo);

  // 2Ô∏è‚É£ Google Sheet ‡§Æ‡§ß‡•Ç‡§® delete ‡§ï‡§∞‡§æ
  const DEPLOY_URL = "https://script.google.com/macros/s/AKfycbzqfYitlp6Nm1RxFtOVlhBSWHn5vAh3fw7xnijJWJF1dISUozPwRhn4bZZP3Lm82a7_/exec";
  try {
    const res = await fetch(`${DEPLOY_URL}?action=delete&estimateNumber=${encodeURIComponent(estNo)}`, {
      method: "POST",
    });
    const out = await res.json();
    if (out.status === "success") {
      console.log("‚úÖ Deleted from Sheet:", estNo);
      alert("Deleted from Sheet: " + estNo);
    } else {
      console.warn("‚ö†Ô∏è Sheet delete failed:", out.message);
      alert("Deleted locally but not from Sheet: " + out.message);
    }
  } catch (err) {
    console.error("‚ùå Error deleting from Sheet:", err);
    alert("Deleted locally but failed to connect to Sheet.");
  }

  // 3Ô∏è‚É£ ‡§™‡•Å‡§¢‡§ö‡§æ Estimate ‡§®‡§Ç‡§¨‡§∞ ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ
  if (typeof generateNextEstimateNo === "function") {
    await generateNextEstimateNo();
  } else if (typeof generateAvailableEstimateNo === "function") {
    el('est-no').value = generateAvailableEstimateNo();
  }
}




async function shareEstimate(estNo){
  try {
    const res = await fetch(`${DEPLOY_URL}?action=getsingle&estimateNumber=${encodeURIComponent(estNo)}`);
    const r = await res.json();
    if(!r["Estimate Number"]){
      alert("Record not found for sharing");
      return;
    }

    const items = JSON.parse(r["Items"] || "[]");
    const lines = [];
    lines.push('üßæ Estimate Details');
    lines.push('');
    
    lines.push('*Vaibhav Enterprises*');
    lines.push('');
    lines.push('_Dear Sir/Madam,_');
    lines.push('Estimate No.: ' + r["Estimate Number"]);
    lines.push('Customer Name: ' + r["Customer Name"]);
    lines.push('Contact No.: ' + r["Customer Whatsapp"]);
    lines.push('Date: ' + new Date(r["Date"]).toLocaleDateString());
    lines.push('');
    lines.push('Item Details:');
    items.forEach(it => {
      lines.push('‚Ä¢ *' + it.name +'*');
      lines.push('_Description: ' + (it.description || '').trim() + '_');
      lines.push('Qty | Unit | Rate | Amount');
      lines.push(`${it.quantity} | ${it.unit || ''} | ‚Çπ${it.rate} | ‚Çπ${(it.quantity * it.rate)}`);
    });
    lines.push('');
    lines.push('Subtotal: ‚Çπ' + r["Subtotal"]);
    lines.push('Discount: ' + r["Discount"] + '%');
    lines.push('*Final Amount: ‚Çπ' + r["Grand Total"] + '*');
    lines.push('_In words: ' + numberToWords(r["Grand Total"] || 0) + '_');
    lines.push('');
    lines.push('_Regarding,_');
    lines.push('');
    lines.push('_Vaibhav Enterprises_');
    lines.push('For more info, visit: www.vaibhaventerprises.info');
    lines.push('_Thank you for connecting with Vaibhav Enterprises_');
    lines.push('');
    lines.push('Open Estimate PDF:https://vai27717.github.io/Your-Estimate/?view=customer&id=' + r["Estimate Number"]);
    window.open('https://wa.me/?text=' + encodeURIComponent(lines.join('\n')), '_blank');
  } catch(err){
    alert("Share failed: "+err.message);
  }
}



/* ---------- PDF Export (Estimate & Invoice) ---------- */
function exportEstimatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 15;

  // --- COMPANY INFO ---
  const c = DATA.company || {};
  const cname = c.name || "Vaibhav Enterprises";
  const ccontact = c.contact || "9049764945 / 8080588206";
  const cwebsite = (c.website && c.website.trim() !== "") ? c.website.trim() : "";
  const creg = (c.regNo && c.regNo.trim() !== "") ? c.regNo.trim() : "";
  const caddr = (c.address && c.address.trim() !== "") ? c.address.trim() : "";

  // --- HEADER ---
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.setTextColor(255, 102, 0);
  doc.text(cname, 105, y, { align: "center" });
  y += 6;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  doc.setTextColor(0);

  // ‚úÖ Mob + Address + Website
  let contactLine = `Mob: ${ccontact}`;
  if (caddr) contactLine += ` | ${caddr}`;
  if (cwebsite) contactLine += ` | ${cwebsite}`;
  doc.text(contactLine, 105, y, { align: "center" });
  y += 5;

  // ‚úÖ Reg. No ‚Äî show only if available
  if (creg) {
    doc.text(`Reg. No: ${creg}`, 105, y, { align: "center" });
    y += 5;
  }

  // Orange underline
  doc.setDrawColor(255, 102, 0);
  doc.setLineWidth(0.5);
  doc.line(14, y, 196, y);
  y += 10;

  // --- RECORD DATA ---
  const id = el("est-no").value;
  const rec =
    DATA.estimates.find((x) => x.id === id) || {
      id,
      client: el("est-client").value,
      contact: el("est-contact").value,
      date: el("est-date").value,
      work: el("est-work").value,
      items: [],
      subtotal: 0,
      discount: 0,
      total: 0,
    };

  // --- LEFT SIDE ---
  doc.setFontSize(11);
  doc.text("To,", 14, y);
  y += 6;
  doc.text(`Customer Name: ${rec.client}`, 14, y);
  y += 6;
  doc.text(`Contact No.: ${rec.contact}`, 14, y);
  y += 6;
  doc.text(`Work Title: ${rec.work}`, 14, y);

  // --- RIGHT SIDE ---
  let rightY = y - 18;
  doc.text(`Estimate No.: ${rec.id}`, 140, rightY);
  rightY += 6;
  const dt = rec.date ? rec.date.split("-").reverse().join("-") : "";
  doc.text(`Estimate Date: ${dt}`, 140, rightY);
  rightY += 6;

  // ‚úÖ Add Due Date (Estimate Date + 7 days)
  if (rec.date) {
    const due = new Date(rec.date);
    due.setDate(due.getDate() + 7);
    const dueDate = due.toISOString().split("T")[0].split("-").reverse().join("-");
    doc.text(`Due Date: ${dueDate}`, 140, rightY);
  }

  y += 10;

  // --- TABLE HEADERS ---
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Item / Description", 14, y);
  doc.text("Qty", 90, y);
  doc.text("Unit", 110, y);
  doc.text("Rate", 130, y);
  doc.text("Amount", 196 - 14, y, { align: "right" });
  y += 4;

  // Orange line
  doc.setDrawColor(255, 102, 0);
  doc.setLineWidth(0.5);
  doc.line(14, y, 196, y);
  y += 6;

  doc.setFont("helvetica", "normal");

  // --- TABLE ROWS ---
  rec.items.forEach((it) => {
    const qtyText = it.quantity ? String(it.quantity) : "0";
    const descText = (it.description || "").trim();

    doc.setFont("helvetica", "bold");
    doc.text(it.name || "(No Item Name)", 14, y);
    doc.text(qtyText, 90, y);
    doc.text(it.unit || "", 110, y);
    doc.text(money(it.rate), 140, y, { align: "right" });
    doc.text(money(it.quantity * it.rate), 196 - 14, y, { align: "right" });
    y += 5;

    if (descText) {
      doc.setFont("helvetica", "italic");
      doc.setFontSize(10);
      doc.text(descText, 16, y);
      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      y += 6;
    }

    if (y > 240) {
      doc.addPage();
      y = 20;
    }
  });

  // Orange line before totals
  y += 2;
  doc.setDrawColor(255, 102, 0);
  doc.line(14, y, 196, y);
  y += 8;

  // --- TOTALS ---
  const subtotal = parseFloat(rec.subtotal) || 0;
  const discountPercent = parseFloat(rec.discount) || 0;
  const discountValue = (subtotal * discountPercent) / 100;
  const finalAmount = subtotal - discountValue;

  doc.setFont("helvetica", "normal");
  doc.text("Subtotal: " + money(subtotal), 196 - 14, y, { align: "right" });
  y += 6;

  if (discountPercent > 0) {
    doc.text(
      `Discount (${discountPercent.toFixed(2)}%): ${money(discountValue)}`,
      196 - 14,
      y,
      { align: "right" }
    );
    y += 6;
  }

  doc.setFont("helvetica", "bold");
  doc.setTextColor(255, 0, 0);
  doc.text("Amount: " + money(finalAmount), 196 - 14, y, { align: "right" });
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");
  y += 10;

  // --- In words ---
  const words = numberToWords(finalAmount || 0);
  doc.setFontSize(10);
  doc.text("In words: " + words, 196 - 14, y, { align: "right" });
  y += 15;

  // --- SIGNATURE ---
  doc.setFontSize(11);
  doc.text("Thank you", 196 - 35, y);
  y += 6;
  doc.setFont("helvetica", "bold");
  doc.text(`For ${cname}`, 196 - 50, y);

  // --- FOOTER ---
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");

  const footerText = cwebsite
    ? `Thank you for connecting with ${cname} | ${cwebsite}`
    : `Thank you for connecting with ${cname}`;

  doc.text(footerText, 105, 290, { align: "center" });

  doc.save(`${rec.id}_estimate.pdf`);
}

// --- Money formatter ---
function money(v) {
  return (parseFloat(v) || 0)
    .toFixed(2)
    .replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}



/* -------------------------------------------------------------
 * 2Ô∏è‚É£ INVOICE (Local Storage Implementation)
 * ------------------------------------------------------------- */

function clearInvoiceForm() {
    el('inv-no').value = '';
    el('inv-client').value = '';
    el('inv-contact').value = '';
    el('inv-date').value = new Date().toISOString().slice(0, 10);
    el('inv-work').value = '';
    el('inv-adv').value = '0';
    el('inv-items').innerHTML = '';
    recalcAll();
    el('inv-no').value = generateAvailableInvoiceNo();

}

function generateAvailableInvoiceNo() {
    const used = DATA.invoices.map(e => parseInt(e.id.replace("INV-", ""))).filter(n => !isNaN(n));
    let next = 1;
    while (used.includes(next)) next++;
    return "INV-" + String(next).padStart(4, "0");
}



function saveInvoice() {
  const items = [];
  el('inv-items').querySelectorAll('.item-row').forEach(div => {
    const name = div.querySelector('.item-name').value;
    if (!name) return;
    const qty = Number(div.querySelector('.item-qty').value) || 0;
    const rate = Number(div.querySelector('.item-rate').value) || 0;

    items.push({
      name,
      unit: div.querySelector('.item-unit').value,
      quantity: qty,
      rate: rate,
      description: div.querySelector('.item-desc').value || '',
      total: qty * rate
    });
  });

  if (!items.length) {
    return alert("Please add at least one item.");
  }

  const subtotal = items.reduce((sum, it) => sum + it.total, 0);
  const advance = Number(el('inv-adv').value) || 0;
  const grandTotal = subtotal;
  let invNo = el('inv-no').value.trim();

  // ‚úÖ ‡§ú‡§∞ ‡§π‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§Ü‡§ß‡•Ä‡§ö ‡§µ‡§æ‡§™‡§∞‡§≤‡§æ ‡§Ö‡§∏‡•á‡§≤ ‡§™‡§£ ‡§§‡•ã‡§ö invoice edit ‡§ï‡§∞‡§§ ‡§Ö‡§∏‡§∂‡•Ä‡§≤ ‡§§‡§∞ new number ‡§®‡§ï‡•ã
  const existingIndex = DATA.invoices.findIndex(e => e.id === invNo);
  const isNew = existingIndex === -1;

  // ‚úÖ ‡§ú‡§∞ ‡§´‡•Ä‡§≤‡•ç‡§° ‡§∞‡§ø‡§ï‡§æ‡§Æ‡§Ç ‡§Ö‡§∏‡•á‡§≤ (‡§®‡§µ‡•Ä‡§® invoice) ‡§§‡§∞ ‡§®‡§µ‡•Ä‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡•á
  if (!invNo || !invNo.startsWith('INV-') || !/INV-\d{4}/.test(invNo)) {
    invNo = generateAvailableInvoiceNo();
    el('inv-no').value = invNo;
  }

  const rec = {
    id: invNo,
    client: el('inv-client').value || '',
    contact: el('inv-contact').value || '',
    date: el('inv-date').value || new Date().toISOString().slice(0, 10),
    work: el('inv-work').value || '',
    items: items,
    subtotal: subtotal.toFixed(2),
    advance: advance.toFixed(2),
    grandTotal: grandTotal.toFixed(2)
  };

  if (isNew) {
    // üü¢ ‡§®‡§µ‡•Ä‡§® ‡§á‡§®‡§µ‡•ç‡§π‡•â‡§à‡§∏ ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ push ‡§ï‡§∞‡§æ
    DATA.invoices.push(rec);
    const currentCounter = parseInt(invNo.replace('INV-', '')) || 0;
    if (currentCounter >= DATA.counters.inv) {
      DATA.counters.inv = currentCounter + 1;
    }
    alert("Invoice saved: " + invNo);
  } else {
    // üü† Existing ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ update ‡§ï‡§∞‡§æ, ‡§™‡§£ ‡§®‡§Ç‡§¨‡§∞ ‡§¨‡§¶‡§≤‡•Ç ‡§®‡§ï‡§æ
    DATA.invoices[existingIndex] = rec;
    alert("Invoice updated: " + invNo);
  }

  saveData();
  clearInvoiceForm();
}

function renderInvoicesList() {
    const box = el('saved-inv-list');
    if (!box) return;
    box.innerHTML = '';

    (DATA.invoices || []).sort((a, b) => b.id.localeCompare(a.id)).forEach(e => {
        const div = document.createElement('div');
        div.className = 'p-2 bg-gray-700 rounded flex flex-wrap justify-between items-center text-sm mb-1';

        // Calculate total received payments for this invoice
        const received = (DATA.payments || [])
            .filter(p => p.invoiceNo === e.id)
            .reduce((sum, p) => sum + (parseFloat(p.received) || 0), 0);

        const balance = (parseFloat(e.grandTotal) || 0) - received;

        div.innerHTML = `
            <div class="flex-1 min-w-[200px]">
                <strong>${e.id}</strong> (${e.date}) ${e.client || 'N/A'} 
                | Total: ‚Çπ${e.grandTotal} | Paid: ‚Çπ${received.toFixed(2)} | *Bal: ‚Çπ${balance.toFixed(2)}*
            </div>
            <div class="flex gap-2 mt-2 md:mt-0">
                <button class="smallbtn" onclick="loadInvoiceRecord('${e.id}')">Load</button>
                <button class="smallbtn" onclick="shareInvoice('${e.id}')">Share</button>
                <button class="smallbtn bg-red-500" onclick="deleteInvoice('${e.id}')">Delete</button>
            </div>
        `;
        box.appendChild(div);
    });
}

window.loadInvoiceRecord = function(invNo) {
    const rec = DATA.invoices.find(e => e.id === invNo);
    if (!rec) {
        alert("Record not found: " + invNo);
        return;
    }
    show('inv');
    el('inv-no').value = rec.id || '';
    el('inv-client').value = rec.client || '';
    el('inv-contact').value = rec.contact || '';
    el('inv-date').value = formatDateToInput(rec.date);
    el('inv-work').value = rec.work || '';
    el('inv-adv').value = rec.advance || '0';
    
    const container = el('inv-items');
    container.innerHTML = '';
    (rec.items || []).forEach(it => {
        addItem('inv', it); 
    });
    recalcAll();
};

function deleteInvoice(invNo) {
    if (!confirm("Are you sure you want to delete Invoice " + invNo + "?\n\nAll associated Expenses and Payments will remain as records but lose the Invoice link.")) return;

    DATA.invoices = DATA.invoices.filter(e => e.id !== invNo);

    // Remove invoice links from other records
    DATA.expenses.forEach(e => { if (e.invoiceNo === invNo) e.invoiceNo = 'N/A'; });
    DATA.payments.forEach(p => { if (p.invoiceNo === invNo) p.invoiceNo = 'N/A'; });
    DATA.orders.forEach(o => { if (o.invoiceId === invNo) o.invoiceId = 'N/A'; });
    DATA.paidPayments.forEach(pp => { if (pp.invoiceNo === invNo) pp.invoiceNo = 'N/A'; });

    saveData();
    alert("Invoice deleted: " + invNo);

    // ‚úÖ Reset invoice no. field to next available
    el('inv-no').value = generateAvailableInvoiceNo();
}


function shareInvoice(invNo) { 
    const r = DATA.invoices.find(e => e.id === invNo); 
    if (!r) { alert("Record not found for sharing"); return; }

    // Get payments linked to this invoice
    const payments = (DATA.payments || []).filter(p => p.invoiceNo === invNo);
    const totalReceived = payments.reduce((sum, p) => sum + (parseFloat(p.received) || 0), 0);
    const balance = (parseFloat(r.grandTotal) || 0) - totalReceived;

    const lines = [];
    lines.push('üßæ *Invoice Details*');
    lines.push('');
    const c = getCompanyInfo();
    const cname = (DATA.company && DATA.company.name) ? DATA.company.name : "Vaibhav Enterprises";
    const website = (DATA.company && DATA.company.website) ? DATA.company.website.trim() : "";

    lines.push(`*${c.name || cname}*`);
    lines.push('');
    lines.push('Dear Sir/Madam,');
    lines.push('*Invoice No.:* ' + r.id);
    lines.push('*Customer Name:* ' + r.client);
    lines.push('*Contact No.:* ' + r.contact);
    lines.push('*Date:* ' + formatDateToInput(r.date));
    lines.push('');

    lines.push('*Item Details:*');
    (r.items || []).forEach(it => {
        lines.push(`‚Ä¢ ${it.name}`);
        if (it.desc) lines.push(`Description: ${it.desc}`);
        lines.push('Qty | Unit | Rate | Amount');
        lines.push(`${it.quantity} | ${it.unit || ''} | ‚Çπ${parseFloat(it.rate).toFixed(2)} | ‚Çπ${parseFloat(it.total).toFixed(2)}`);
    });

    lines.push('');
    lines.push('*Subtotal:* ‚Çπ' + parseFloat(r.grandTotal).toFixed(2));
    lines.push('*Advance:* ‚Çπ' + totalReceived.toFixed(2));
    lines.push('*Final Amount:* ‚Çπ' + balance.toFixed(2));
    lines.push('In words: ' + numberToWords(balance) + ' only');
    lines.push('');

    if (payments.length > 0) {
        lines.push('*Receive Advance Details:üëá*');
        lines.push('No  |    Date        |  Amount   | Type');
        payments.forEach((p, i) => {
            lines.push(`${i + 1}   | ${formatDateToInput(p.date)} | ‚Çπ${parseFloat(p.received).toFixed(2)} | ${p.note || 'Cash'}`);
        });
        lines.push('');
    }

    lines.push('Regarding,');
    lines.push('');
    lines.push(`${c.name || cname}`);
    // ‚úÖ Show website line only if it exists and not empty
    if (website) {
        lines.push(`For more info, visit: ${website}`);
    }

    lines.push(`Thank you for connecting with ${cname}`);
    lines.push('');

    window.open('https://wa.me/?text=' + encodeURIComponent(lines.join('\n')), '_blank');
}






/* ---------- ----------------------------PDF Export (Invoice)------------------------------------- ---------- */
/* ---------- PDF Export (Invoice) ---------- */
function exportInvoicePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 15;

  // --- COMPANY INFO ---
  // ‚úÖ Estimate code pramane DATA.company object vaparat ahe
  const c = DATA.company || {};
  const cname = c.name || "Vaibhav Enterprises";
  const ccontact = c.contact || "9049764945 / 8080588206";
  const cwebsite = (c.website && c.website.trim() !== "") ? c.website.trim() : "";
  const creg = (c.regNo && c.regNo.trim() !== "") ? c.regNo.trim() : "";
  const caddr = (c.address && c.address.trim() !== "") ? c.address.trim() : "";

  // --- HEADER ---
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.setTextColor(255, 102, 0);
  // ‚úÖ Company name 'Vaibhav Enterprises' chya jagi 'cname' vaparat ahe
  doc.text(cname, 105, y, { align: "center" });
  y += 6;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  doc.setTextColor(0);

  // ‚úÖ Mob + Address + Website (Estimate code pramane)
  let contactLine = `Mob: ${ccontact}`;
  if (caddr) contactLine += ` | ${caddr}`;
  if (cwebsite) contactLine += ` | ${cwebsite}`;
  doc.text(contactLine, 105, y, { align: "center" });
  y += 5;

  // ‚úÖ Reg. No ‚Äî show only if available (Estimate code pramane)
  if (creg) {
    doc.text(`Reg. No: ${creg}`, 105, y, { align: "center" });
    y += 5;
  }

  // Orange underline
  doc.setDrawColor(255, 102, 0);
  doc.setLineWidth(0.5);
  doc.line(14, y, 196, y);
  y += 10;

  // ---------- RECORD DATA ----------
  const id = el('inv-no').value;
  const rec = DATA.invoices.find(x => x.id === id) || {
    id, client: el('inv-client').value, contact: el('inv-contact').value,
    date: el('inv-date').value, work: el('inv-work').value,
    items: [], subtotal: 0, grandTotal: 0
  };

  // ‚úÖ Total Paid (Received) from Payments
  const totalPaid = (DATA.payments || [])
    .filter(p => p.invoiceNo === rec.id)
    .reduce((sum, p) => sum + (parseFloat(p.received) || 0), 0);

  // ‚úÖ Calculate Amount = GrandTotal - Paid
  const amountAfterPaid = (parseFloat(rec.grandTotal) || 0) - totalPaid;

  // ---------- LEFT SIDE ----------
  doc.setFontSize(11);
  doc.text("To,", 14, y);
  y += 6;
  doc.text(`Customer Name: ${rec.client}`, 14, y);
  y += 6;
  doc.text(`Contact No.: ${rec.contact}`, 14, y);
  y += 6;
  doc.text(`Work Title: ${rec.work}`, 14, y);

  // ---------- RIGHT SIDE ----------
  let rightY = y - 18;
  doc.text(`Invoice No.: ${rec.id}`, 140, rightY);
  rightY += 6;
  const dt = rec.date ? rec.date.split("-").reverse().join("-") : "";
  doc.text(`Invoice Date: ${dt}`, 140, rightY); // 'Date' chya jagi 'Invoice Date' kele
  y += 10;

  // ---------- TABLE HEADER ----------
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Item / Description", 14, y);
  doc.text("Qty", 90, y);
  doc.text("Unit", 110, y);
  doc.text("Rate", 130, y);
  doc.text("Amount", 196 - 14, y, { align: 'right' });
  y += 4;

  doc.setDrawColor(255, 102, 0);
  doc.line(14, y, 196, y);
  y += 6;
  doc.setFont("helvetica", "normal");

  // ---------- TABLE ROWS ----------
  rec.items.forEach(it => {
    const qtyText = (it.quantity !== undefined && it.quantity !== '') ? String(it.quantity) : "0";
    const descText = (it.description && it.description.trim() !== "") ? it.description.trim() : "";

    doc.setFont("helvetica", "bold");
    doc.text(it.name || "(No Item Name)", 14, y);
    doc.text(qtyText, 90, y);
    doc.text(it.unit || '', 110, y);
    doc.text(money(it.rate), 140, y, { align: 'right' });
    doc.text(money(it.quantity * it.rate), 196 - 14, y, { align: 'right' });
    y += 5;

    if (descText) {
      doc.setFont("helvetica", "italic");
      doc.setFontSize(10);
      doc.text(descText, 16, y);
      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      y += 6;
    }

    if (y > 240) { doc.addPage(); y = 20; }
  });

  // ---------- TOTALS SECTION ----------
  y += 2;
  doc.setDrawColor(255, 102, 0);
  doc.line(14, y, 196, y);
  y += 8;

  doc.setFont("helvetica", "normal");
  doc.text("Subtotal: " + money(rec.subtotal || 0), 196 - 14, y, { align: 'right' });
  y += 6;

  if (totalPaid > 0) {
    doc.text("Paid: " + money(totalPaid), 196 - 14, y, { align: 'right' });
    y += 6;
  }

  doc.setFont("helvetica", "bold");
  doc.setTextColor(255, 0, 0);
  doc.text("Amount: " + money(amountAfterPaid), 196 - 14, y, { align: 'right' });
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");
  y += 10;

  // ---------- IN WORDS ----------
  const words = numberToWords(amountAfterPaid || 0);
  doc.setFontSize(10);
  doc.text("In words: " + words, 196 - 14, y, { align: 'right' });
  y += 15;

  // ---------- SIGNATURE ----------
  doc.setFontSize(11);
  doc.text("Thank you", 196 - 35, y);
  y += 6;
  doc.setFont("helvetica", "bold");
  // ‚úÖ Company name 'Vaibhav Enterprises' chya jagi 'cname' vaparat ahe
  doc.text(`For ${cname}`, 196 - 50, y);

  // --- FOOTER ---
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");

  // ‚úÖ Footer Estimate code pramane update kele
  const footerText = cwebsite
    ? `Thank you for connecting with ${cname} | ${cwebsite}`
    : `Thank you for connecting with ${cname}`;

  doc.text(footerText, 105, 290, { align: "center" });

  doc.save(`${rec.id}_invoice.pdf`);
}

// /* ---------- Money Formatter (Tumi dilela) ---------- */
 function money(v){
   return (parseFloat(v)||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}




/* -------------------------------------------------------------
 * 3Ô∏è‚É£ EXPENSES (Local Storage Implementation)
 * ------------------------------------------------------------- */
function renderCategorySelect() {
    const select = el('cat-select');
    const ordSelect = el('ord-category');
    if (!select || !ordSelect) return;
    
    const currentCategories = DATA.categories || ["Material", "Labor", "Transport", "Miscellaneous"];
    
    // Update Expenses Select
    const currentVal = select.value;
    select.innerHTML = '<option value="">-- Select Category --</option>';
    currentCategories.forEach(cat => {
        select.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
    select.value = currentVal;

    // Update Orders Select (if empty)
    if(ordSelect.options.length <= 1) { // Only '-- Select Category --' exists
        currentCategories.forEach(cat => {
            ordSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
    }
}

// ‚úÖ Category Dropdown Render Function
function renderCategoryList() {
  const sel = document.getElementById('cat-select');
  if (!sel) return;

  // dropdown ‡§∞‡§ø‡§ï‡§æ‡§Æ‡§æ ‡§ï‡§∞‡•Ç‡§® default option ‡§ü‡§æ‡§ï
  sel.innerHTML = '<option value="">-- Select Category --</option>';

  // ‡§ú‡§∞ DATA.categories ‡§®‡§∏‡§§‡•Ä‡§≤ ‡§§‡§∞ ‡§∞‡§ø‡§ï‡§æ‡§Æ‡§æ array ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞
  if (!Array.isArray(DATA.categories)) DATA.categories = [];

  // ‡§∏‡§∞‡•ç‡§µ categories ‡§¶‡§æ‡§ñ‡§µ‡§æ
  DATA.categories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    sel.appendChild(opt);
  });
}

// ‚úÖ Category Add Function
function addCategoryPrompt() {
  const newCat = prompt("Enter new category name:");
  if (newCat && newCat.trim()) {
    const trimmedCat = newCat.trim();
    if (!Array.isArray(DATA.categories)) DATA.categories = [];

    if (!DATA.categories.includes(trimmedCat)) {
      DATA.categories.push(trimmedCat);
      saveData();
      renderCategoryList(); // dropdown refresh ‡§ï‡§∞‡§æ
      alert("Category added!");
    } else {
      alert("Category already exists.");
    }
  }
}

// ‚úÖ Category Delete Function
function deleteCategoryPrompt() {
  const sel = document.getElementById('cat-select');
  if (!sel) return alert("Category dropdown not found!");

  const catToDelete = sel.value;
  if (!catToDelete) return alert("Please select a category to delete.");
  if (!confirm(`Are you sure you want to delete category "${catToDelete}"?`)) return;

  // Delete category from list
  DATA.categories = (DATA.categories || []).filter(cat => cat !== catToDelete);

  // ‡§ú‡§∞ ‡§ï‡§æ‡§π‡•Ä expenses ‡§§‡•ç‡§Ø‡§æ category ‡§µ‡§∞ ‡§Ö‡§∏‡§§‡•Ä‡§≤, ‡§§‡§∞ ‡§§‡•ç‡§Ø‡§æ‡§§ 'N/A' ‡§ï‡§∞‡§æ
  (DATA.expenses || []).forEach(e => {
    if (e.category === catToDelete) e.category = 'N/A';
  });

  saveData();
  renderCategoryList(); // Refresh dropdown
  alert("Category deleted and removed from associated expenses.");
}

// ‚úÖ ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ categories render ‡§ï‡§∞‡§æ
window.addEventListener('load', () => {
  if (!Array.isArray(DATA.categories)) DATA.categories = [];
  renderCategoryList();
});



let expenseIdToEdit = null;

function addExpenseRow(data = {}) {
    const parent = el('exp-rows');
    const row = document.createElement('tr');
    row.className = 'expense-row border rounded p-3';
    row.innerHTML = `
        <td data-label="Date"><input type="date" class="exp-date w-full" value="${data.date || new Date().toISOString().slice(0, 10)}"></td>
        <td data-label="Item Name"><input type="text" class="exp-name w-full" placeholder="Item/Vendor" value="${data.name || ''}"></td>
       <td data-label="Category">
  <input type="text" class="exp-cat w-full" placeholder="Category"
         value="${data.category || ''}" 
         oninput="filterCategorySuggestions(this)" autocomplete="off">
  <div class="cat-suggestions absolute bg-white border shadow-md z-10 hidden"></div>
</td>


        <td data-label="Qty"><input type="number" class="exp-qty w-full" placeholder="Qty" value="${data.quantity || 1}" oninput="calculateExpenseAmount(this)"></td>
        <td data-label="Unit"><input type="text" class="exp-unit w-full" placeholder="Unit" value="${data.unit || 'pc'}"></td>
        <td data-label="Rate"><input type="number" class="exp-rate w-full" placeholder="Rate" value="${data.rate || 0}" oninput="calculateExpenseAmount(this)"></td>
        <td data-label="Amount"><input type="number" class="exp-amount w-full" placeholder="Amount" value="${data.amount || 0}" disabled></td>
        <td data-label="Action"><button class="smallbtn bg-red-500" onclick="this.closest('.expense-row').remove()">‚úï</button></td>
    `;
    parent.appendChild(row);
    // Initial calculation if data is loaded
    if (data.name) calculateExpenseAmount(row.querySelector('.exp-rate')); 
}

function filterCategorySuggestions(input) {
  const container = input.nextElementSibling; // suggestions div
  const search = input.value.toLowerCase();
  const matches = (DATA.categories || []).filter(cat => cat.toLowerCase().includes(search));

  // If no matches or empty, hide
  if (!search || matches.length === 0) {
    container.classList.add("hidden");
    return;
  }

  // Create suggestion list
  container.innerHTML = matches
    .map(cat => `<div class="cat-item p-1 hover:bg-gray-200 cursor-pointer">${cat}</div>`)
    .join("");
  container.classList.remove("hidden");

  // Click to select
  container.querySelectorAll(".cat-item").forEach(item => {
    item.onclick = () => {
      input.value = item.textContent;
      container.classList.add("hidden");
    };
  });

  // ‚úÖ Hide suggestions after blur (user focus ‡§¨‡§¶‡§≤‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞)
  input.addEventListener("blur", () => {
    setTimeout(() => container.classList.add("hidden"), 200);
  });
}




function calculateExpenseAmount(input) {
    const row = input.closest('.expense-row');
    const qty = parseFloat(row.querySelector('.exp-qty').value) || 0;
    const rate = parseFloat(row.querySelector('.exp-rate').value) || 0;
    const amount = qty * rate;
    row.querySelector('.exp-amount').value = amount.toFixed(2);
    // Optional: Recalculate total for display
    let total = 0;
    document.querySelectorAll('#exp-rows .exp-amount').forEach(i => total += parseFloat(i.value) || 0);
    el('exp-total').textContent = total.toFixed(2);
}

function saveExpenses() {
  const invoiceNo = el("exp-invoice-select").value;
  if (!invoiceNo) return alert("Please select an Invoice No.");

  if (!Array.isArray(DATA.categories)) DATA.categories = [];

  const items = [];
  const allCats = [];

  document.querySelectorAll("#exp-rows .expense-row").forEach(row => {
    const name = row.querySelector(".exp-name").value.trim();
    const qty = row.querySelector(".exp-qty").value.trim();
    const unit = row.querySelector(".exp-unit").value.trim();
    const rate = row.querySelector(".exp-rate").value.trim();
    const amount = parseFloat(row.querySelector(".exp-amount").value) || 0;
    const category = row.querySelector(".exp-cat").value.trim();
    const date = row.querySelector(".exp-date").value;

    if (name && amount > 0) {
      items.push({ date, category, name, qty, unit, rate, amount });
      if (category) allCats.push(category);
      if (category && !DATA.categories.includes(category)) {
        DATA.categories.push(category);
      }
    }
  });

  if (!items.length) return alert("Please add at least one valid expense item.");

  const merged = {
    id: "EXP-" + String(++DATA.counters.exp).padStart(6, "0"),
    invoiceNo,
    date: items.map(i => i.date).join(", "),
    category: allCats.join(", "),
    name: items.map(i => i.name).join(", "),
    quantity: items.map(i => i.qty).join(", "),
    unit: items.map(i => i.unit).join(", "),
    rate: items.map(i => i.rate).join(", "),
    amount: items.reduce((sum, i) => sum + i.amount, 0).toFixed(2)
  };

  // ‚úÖ ‡§ú‡§∞ ‡§Ü‡§ß‡•Ä‡§ö ‡§π‡§æ‡§ö invoiceNo ‡§Ö‡§∏‡•ç‡§§‡§ø‡§§‡•ç‡§µ‡§æ‡§§ ‡§Ö‡§∏‡•á‡§≤, ‡§§‡§∞ ‡§ú‡•Å‡§®‡•Ä entry replace ‡§ï‡§∞‡§æ
  const existingIndex = DATA.expenses.findIndex(e => e.invoiceNo === invoiceNo);
  if (existingIndex !== -1) {
    merged.id = DATA.expenses[existingIndex].id; // ‡§ú‡•Å‡§®‡§æ ID ‡§†‡•á‡§µ
    DATA.expenses[existingIndex] = merged;
    alert(`‚úÖ Updated: Invoice ${invoiceNo} (Replaced old entry)`);
  } else {
    DATA.expenses.push(merged);
    alert(`‚úÖ Saved new Expense for Invoice ${invoiceNo}`);
  }

  saveData();
  renderCategoryList();
  el("exp-rows").innerHTML = "";
  el("exp-total").textContent = "0.00";
  renderExpensesList();
  renderInvoiceProfits();
  updateHomeSummary();
}



function loadExpense(id) {
  const rec = DATA.expenses.find(e => e.id === id);
  if (!rec) return alert("Expense not found!");

  show('exp');
  el('exp-invoice-select').value = rec.invoiceNo;
  el('exp-rows').innerHTML = '';

  const dates = rec.date.split(',').map(s => s.trim());
  const items = rec.name.split(',').map(s => s.trim());
  const qtys = rec.quantity.split(',').map(s => s.trim());
  const units = rec.unit.split(',').map(s => s.trim());
  const rates = rec.rate.split(',').map(s => s.trim());
  const cats = rec.category.split(',').map(s => s.trim());

  const len = Math.max(items.length, qtys.length, rates.length);

  for (let i = 0; i < len; i++) {
    addExpenseRow({
      date: dates[i] || new Date().toISOString().slice(0, 10),
      name: items[i] || '',
      category: cats[i] || '',        // ‚úÖ use 'category' instead of 'cat'
      quantity: qtys[i] || 1,
      unit: units[i] || '',
      rate: rates[i] || 0
    });
  }

  expenseIdToEdit = id;
}



function renderExpensesList() {
  const tbody = el('expenses-tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  (DATA.expenses || []).sort((a, b) => b.date.localeCompare(a.date)).forEach(e => {
    const tr = document.createElement('tr');
    tr.className = 'text-sm';
    tr.innerHTML = `
      <td data-label="Date">${e.date}</td>
      <td data-label="Invoice No" class="font-bold text-yellow-300">${e.invoiceNo}</td>
      <td data-label="Category">${e.category}</td>
      <td data-label="Items">${e.name}</td>
      <td data-label="Qty">${e.quantity}</td>
      <td data-label="Unit">${e.unit}</td>
      <td data-label="Rate">‚Çπ${e.rate}</td>
      <td data-label="Amount" class="font-semibold text-red-400">‚Çπ${money(e.amount)}</td>
      <td data-label="Action" class="flex gap-1">
        <button class="smallbtn bg-blue-500" title="Load/Edit" onclick="loadExpense('${e.id}')">üîÑ</button>
        <button class="smallbtn bg-green-500" title="Report" onclick="exportExpensePDF('${e.id}')">üñ®Ô∏è</button>
        <button class="smallbtn bg-red-500" title="Delete" onclick="deleteExpense('${e.id}')">‚úï</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  renderInvoiceProfits();
  updateHomeSummary();
}


function deleteExpense(expenseId) {
    if (!confirm("Delete this expense record?")) return;
    DATA.expenses = DATA.expenses.filter(e => e.id !== expenseId);
    saveData();
    alert("Expense deleted.");
}


function renderInvoiceProfits() {
    const profitDiv = el('invoice-profits');
    if (!profitDiv) return;
    
    const summary = {};
    
    // 1. Collect Invoice Totals
    (DATA.invoices || []).forEach(inv => {
        summary[inv.id] = { 
            total: parseFloat(inv.grandTotal) || 0, 
            expenses: 0, 
            client: inv.client,
            work: inv.work 
        };
    });
    
    // 2. Collect Expenses
    (DATA.expenses || []).forEach(exp => {
        const invId = exp.invoiceNo;
        if (summary[invId]) {
            summary[invId].expenses += (parseFloat(exp.amount) || 0);
        } else {
            // Expenses without a valid Invoice ID
            const miscId = 'MISC';
            if (!summary[miscId]) summary[miscId] = { total: 0, expenses: 0, client: 'N/A', work: 'MISCELLANEOUS' };
            summary[miscId].expenses += (parseFloat(exp.amount) || 0);
        }
    });

    // 3. Render Table
    let html = `
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr>
                        <th>Invoice No</th>
                        <th>Client</th>
                        <th>Invoice Total (A)</th>
                        <th>Expenses (B)</th>
                        <th>Profit (A-B)</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    let totalProfit = 0;
    
    Object.keys(summary).sort((a, b) => b.localeCompare(a)).forEach(id => {
        const s = summary[id];
        const profit = s.total - s.expenses;
        totalProfit += profit;
        
        const profitClass = profit >= 0 ? 'text-green-400' : 'text-red-400';

        html += `
            <tr class="text-sm">
                <td data-label="Invoice No" class="font-bold">${id}</td>
                <td data-label="Client">${s.client}</td>
                <td data-label="Inv. Total">‚Çπ${money(s.total)}</td>
                <td data-label="Expenses">‚Çπ${money(s.expenses)}</td>
                <td data-label="Profit" class="${profitClass}">‚Çπ${money(profit)}</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
            <tfoot>
                <tr class="font-bold bg-gray-600">
                    <td colspan="4" class="text-right">Total Profit:</td>
                    <td class="${totalProfit >= 0 ? 'text-green-400' : 'text-red-400'}">‚Çπ${money(totalProfit)}</td>
                </tr>
            </tfoot>
        </table>
        </div>
    `;

    profitDiv.innerHTML = html;
}

function renderExpensesChart() {
    // Logic for Chart.js implementation using DATA.expenses
    // (Skipped for brevity but would use Chart.js API with DATA.expenses)
}

function populateInvoiceSelects() {
    const invSelects = [el('exp-invoice-select'), el('order-invoice-select'), el('pp-invno'), el('pay-invno')];
    const invoices = DATA.invoices || [];
    
    invSelects.forEach(select => {
        if (!select) return;
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- Select Invoice --</option>';
        invoices.sort((a, b) => b.id.localeCompare(a.id)).forEach(inv => {
            select.innerHTML += `<option value="${inv.id}">${inv.id} - ${inv.client}</option>`;
        });
        select.value = currentVal;
    });

    // Populate Order IDs for Paid Payments
    const orderSelect = el('pp-order-id');
    if (orderSelect) {
        const currentVal = orderSelect.value;
        orderSelect.innerHTML = '<option value="">-- Select Order ID --</option>';
        (DATA.orders || []).sort((a, b) => b.id.localeCompare(a.id)).forEach(ord => {
            orderSelect.innerHTML += `<option value="${ord.id}">${ord.id} - ${ord.client}</option>`;
        });
        orderSelect.value = currentVal;
    }
}

async function exportExpensePDF(id) {
  const { jsPDF } = window.jspdf;
  const rec = (DATA.expenses || []).find(x => x.id === id);
  if (!rec) return alert("Expense not found!");

  const doc = new jsPDF();
  let y = 15;

  // --- HEADER ---
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("Expense Report", 105, y, { align: "center" });
  y += 8;

  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  doc.text(`Invoice No: ${rec.invoiceNo || "-"}`, 14, y);
  doc.text(`Date(s): ${rec.date || ""}`, 105, y);
  doc.text(`Total: ${rec.amount || 0}`, 196 - 14, y, { align: "right" });
  y += 10;

  // --- TABLE HEADER WITH BACKGROUND COLOR ---
  doc.setFillColor(200, 220, 255); // light blue
  doc.rect(10, y - 4, 190, 8, "F"); // background rectangle

  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.text("Date", 14, y);
  doc.text("Item", 40, y);
  doc.text("Category", 80, y);
  doc.text("Qty", 120, y);
  doc.text("Unit", 135, y);
  doc.text("Rate", 150, y);
  doc.text("Amount", 196 - 14, y, { align: "right" });
  y += 6;

  // --- Split merged fields back into arrays ---
  const dates = (rec.date || "").split(",").map(s => s.trim());
  const names = (rec.name || "").split(",").map(s => s.trim());
  const cats = (rec.category || "").split(",").map(s => s.trim());
  const qtys = (rec.quantity || "").split(",").map(s => s.trim());
  const units = (rec.unit || "").split(",").map(s => s.trim());
  const rates = (rec.rate || "").split(",").map(s => s.trim());

  // --- Category totals accumulator ---
  const categoryTotals = {};

  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);

  for (let i = 0; i < names.length; i++) {
    const date = dates[i] || "-";
    const item = names[i] || "-";
    const cat = cats[i] || "-";
    const qty = parseFloat(qtys[i]) || 0;
    const unit = units[i] || "-";
    const rate = parseFloat(rates[i]) || 0;
    const amount = qty * rate;

    doc.text(date, 14, y);
    doc.text(item, 40, y);
    doc.text(cat, 80, y);
    doc.text(String(qty), 120, y);
    doc.text(unit, 135, y);
    doc.text("" + rate.toFixed(2), 150, y);
    doc.text("" + amount.toFixed(2), 196 - 14, y, { align: "right" });
    y += 6;

    // ‚úÖ Category totals with details
    if (!categoryTotals[cat]) categoryTotals[cat] = [];
    categoryTotals[cat].push({
      name: item,
      qty,
      unit,
      amount,
    });

    // --- Page break ---
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
  }

  // --- GRAND TOTAL ---
  y += 4;
  doc.setFont("helvetica", "bold");
  doc.text("Grand Total: " + (rec.amount || "0.00"), 196 - 14, y, { align: "right" });
  y += 8;

  // --- CATEGORY-WISE SUMMARY ---
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("Category-wise Summary", 14, y);
  y += 6;

  Object.keys(categoryTotals).forEach(cat => {
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.text(cat, 14, y);
    y += 6;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.setFillColor(230, 230, 230);
    doc.rect(12, y - 4, 182, 7, "F");
    doc.text("Name", 16, y);
    doc.text("Qty", 80, y);
    doc.text("Unit", 100, y);
    doc.text("Amount", 196 - 14, y, { align: "right" });
    y += 5;

    doc.setFont("helvetica", "normal");
    categoryTotals[cat].forEach(it => {
      doc.text(it.name, 16, y);
      doc.text(String(it.qty), 80, y);
      doc.text(it.unit, 100, y);
      doc.text("" + it.amount.toFixed(2), 196 - 14, y, { align: "right" });
      y += 6;
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
    });

    // add gap between categories
    y += 4;
  });

  // --- FOOTER ---
  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  doc.text("Generated: " + new Date().toLocaleString(), 14, 290);

  doc.save(`${rec.invoiceNo || rec.id}_Expense_Report.pdf`);
}



function loadExpensesByInvoice(invoiceNo) {
    const table = document.getElementById('expense-items');
    table.innerHTML = '';

    const related = (DATA.expenses || []).filter(e => e.invoiceNo === invoiceNo);

    related.forEach(item => {
        const row = document.createElement('div');
        row.className = 'expense-row grid grid-cols-6 gap-2 border-b py-2';

        row.innerHTML = `
            <input type="date" value="${item.date}" class="col-span-1 p-2 border rounded" />
            <input type="text" value="${item.name}" class="col-span-1 p-2 border rounded" />
            <input type="text" value="${item.category}" class="col-span-1 p-2 border rounded" />
            <input type="number" value="${item.quantity}" class="col-span-1 p-2 border rounded" />
            <input type="text" value="${item.unit}" class="col-span-1 p-2 border rounded" />
            <input type="number" value="${item.rate}" class="col-span-1 p-2 border rounded" />
        `;
        table.appendChild(row);
    });
}




/* -------------------------------------------------------------
 * 4Ô∏è‚É£ MEASUREMENTS (Local Storage Implementation)
 * ------------------------------------------------------------- */

let msrIdToEdit = null;

/* ---------- Measurements ---------- */
function addMeasurement(data){
  const parent = el('meas-items');
  const div = document.createElement('div'); 
  div.className='p-2 border rounded bg-gray-50 meas-row';   

  div.innerHTML = `
    <div class="grid md:grid-cols-5 gap-2 items-center">
      <input class="meas-name p-2" placeholder="Item">
      <input class="meas-w p-2" type="number" placeholder="Width">
      <input class="meas-h p-2" type="number" placeholder="Height">
      <select class="meas-unit-select p-2 border rounded">
        <option value="feet">Feet</option>
        <option value="meter">Meter</option>
        <option value="inch">Inch</option>
        <option value="cm">Centimeter</option>
      </select>
      <div class="flex items-center">
        Area: <span class="meas-area font-semibold ml-2">0.00</span> 
        <span class="meas-unit ml-1 text-sm">R.ft</span>
      </div>
    </div>
    <div class="mt-2 text-right">
      <button class="smallbtn" onclick="this.closest('.meas-row').remove(); recalcTotals()">Remove</button>
    </div>`;
  parent.appendChild(div);

  if(data){ 
    div.querySelector('.meas-name').value = data.name||''; 
    div.querySelector('.meas-w').value = data.w||0; 
    div.querySelector('.meas-h').value = data.h||0; 
    div.querySelector('.meas-unit-select').value = data.unitType || 'feet';
    updateMeas(div); 
  }

  div.querySelector('.meas-w').addEventListener('input', ()=> updateMeas(div));
  div.querySelector('.meas-h').addEventListener('input', ()=> updateMeas(div));
  div.querySelector('.meas-unit-select').addEventListener('change', ()=> updateMeas(div));
}

function convertToFeet(val, unitType){
  switch(unitType){
    case 'meter': return val * 3.28084;
    case 'inch': return val / 12;
    case 'cm': return val / 30.48;
    default: return val; // feet
  }
}

function updateMeas(div){
  const wRaw = parseFloat(div.querySelector('.meas-w').value)||0;
  const hRaw = parseFloat(div.querySelector('.meas-h').value)||0;
  const unitType = div.querySelector('.meas-unit-select').value;

  const w = convertToFeet(wRaw, unitType);
  const h = convertToFeet(hRaw, unitType);

  let result=0, unit='';
  if(!hRaw){ 
    result=w; unit='R.ft'; 
  } else { 
    result=w*h; unit='Sq.ft'; 
  }

  div.querySelector('.meas-area').textContent = result.toFixed(2);
  div.querySelector('.meas-unit').textContent = unit;

  recalcTotals();
}

function recalcTotals(){
  let totalRft=0, totalSft=0;
  document.querySelectorAll('#meas-items .meas-row').forEach(div=>{
    const wRaw = parseFloat(div.querySelector('.meas-w').value)||0;
    const hRaw = parseFloat(div.querySelector('.meas-h').value)||0;
    const unitType = div.querySelector('.meas-unit-select').value;

    const w = convertToFeet(wRaw, unitType);
    const h = convertToFeet(hRaw, unitType);

    if(!hRaw){ totalRft += w; }
    else { totalSft += w*h; }
  });
  el('meas-total').textContent = `Tot. R.ft: ${totalRft.toFixed(2)} | Tot. Sq.ft: ${totalSft.toFixed(2)}`;
}

function saveMeasurements(){
  const client = el('msr-client').value||'';
  const contact = el('msr-contact').value||'';
  if(!client) return alert("Enter Customer Name");

  const items = [];
  document.querySelectorAll('#meas-items .meas-row').forEach(div=>{   
    const name = div.querySelector('.meas-name').value||'Item';
    const wRaw = parseFloat(div.querySelector('.meas-w').value)||0;
    const hRaw = parseFloat(div.querySelector('.meas-h').value)||0;
    const unitType = div.querySelector('.meas-unit-select').value;

    const w = convertToFeet(wRaw, unitType);
    const h = convertToFeet(hRaw, unitType);

    let result=0, unit='';
    if(!hRaw){ result=w; unit='R.ft'; }
    else { result=w*h; unit='Sq.ft'; }

    items.push({name,w:wRaw,h:hRaw,result:parseFloat(result.toFixed(2)),unit,unitType});
  });

  if(items.length===0) return alert("Add at least one measurement row");

  const existingIndex = DATA.measurements.findIndex(x=>x.client===client && x.contact===contact);
  if(existingIndex !== -1){
    DATA.measurements[existingIndex].items = items;
  } else {
    DATA.counters.msr = (DATA.counters.msr||0)+1;
    const id = 'MSR-'+String(DATA.counters.msr).padStart(4,'0');
    const rec = { id, client, contact, date: new Date().toISOString().split('T')[0], items };
    DATA.measurements.push(rec);
  }

  saveData();
  alert('Measurements saved.');
  renderMeasurementsList();
}

function deleteMeasurement(id){ 
  if(!confirm('Delete?')) return; 
  DATA.measurements = DATA.measurements.filter(x=> x.id !== id); 
  saveData(); 
  renderMeasurementsList();
}

function renderMeasurementsList(){
  const box = el('saved-meas');
  box.innerHTML = '';

  (DATA.measurements||[]).forEach(r=>{
    const div = document.createElement('div');
    div.className = 'p-2 border rounded mb-2';

    let html = `<b>${r.id}</b> ${r.client||''} (${r.contact||''})<br>`;
    if(r.items){
      r.items.forEach(x=>{
        html += `${x.name}: ${x.w}√ó${x.h} = ${x.result.toFixed(2)} ${x.unit}<br>`;
      });
    }

    div.innerHTML = html + `
      <div class="mt-1 flex gap-2">
        <button onclick="loadMeasurement('${r.id}')">Load</button>
        <button onclick="deleteMeasurement('${r.id}')">Delete</button>
        <button onclick="shareMeasurement('${r.id}')">Share</button>
      </div>`;
    box.appendChild(div);
  });
}

function loadMeasurement(id){
  const rec = DATA.measurements.find(x=> x.id === id);
  if(!rec) return alert("Not found");

  el('msr-client').value = rec.client || '';
  el('msr-contact').value = rec.contact || '';

  el('meas-items').innerHTML = '';
  if(rec.items){
    rec.items.forEach(it=> addMeasurement(it));
  }

  show('meas');
  recalcTotals();
}

function shareMeasurement(id) {
  const rec = DATA.measurements.find(x => x.id === id);
  if (!rec) return alert("Not found");

  let text = `üìè Measurement: ${rec.id}\nClient: ${rec.client}\nDate: ${rec.date}\n\n`;
  
  rec.items.forEach(x => {
    text += `${x.name}: ${x.w}√ó${x.h} = ${x.result.toFixed(2)} ${x.unit}\n`;
  });

  if (navigator.share) {
    navigator.share({ title: "Measurement", text });
  } else {
    navigator.clipboard.writeText(text);
    alert("Copied to clipboard ‚úÖ");
  }
}

/* -------------------------------------------------------------
 * 5Ô∏è‚É£ ORDERS (Local Storage Implementation)
 * ------------------------------------------------------------- */

let selectedOrderId = null;

// ‚úÖ ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï item-row ‡§Æ‡§ß‡•ç‡§Ø‡•á Category field ‡§ú‡•ã‡§°‡§≤‡•á
// ‚úÖ ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï item-row ‡§Æ‡§ß‡•ç‡§Ø‡•á Category field ‡§ú‡•ã‡§°‡§≤‡•á
function addOrderRow(data = {}) {
  const parent = el('order-items');
  const row = document.createElement('div');
  
  // üí° ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä:
  // Mobile (Default): 2 Columns (Qty/Rate ‡§è‡§ï‡§æ ‡§ì‡§≥‡•Ä‡§§) ‡§ï‡§ø‡§Ç‡§µ‡§æ 3 columns
  // Desktop (lg:): 7 Columns
  row.className = 'order-row grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-7 gap-2 border-b py-2'; 
                                                                                        // ‚Üë lg:grid-cols-7 Desktop ‡§∏‡§æ‡§†‡•Ä 
                                                                                        // ‚Üë sm:grid-cols-3 (‡§ü‡•Ö‡§¨‡•ç‡§≤‡•á‡§ü‡§∏‡§æ‡§†‡•Ä ‡•©)
                                                                                        // ‚Üë grid-cols-2 (Mobile ‡§∏‡§æ‡§†‡•Ä ‡•®)

  const part = data.part || '';
  const category = data.category || '';
  const qty = data.qty || 0;
  const unit = data.unit || '';
  const rate = data.rate || 0;
  const amount = (qty * rate).toFixed(2);

  row.innerHTML = `
    <input list="materials" class="ord-part w-full p-2 border rounded col-span-2 lg:col-span-2" placeholder="Particular" value="${part}">
    
    <select class="ord-category p-2 border rounded col-span-2 sm:col-span-1 lg:col-span-1">
      <option value="">Select Cat</option>
      ${(DATA.categories || []).map(c => 
        `<option value="${c}" ${c === category ? 'selected' : ''}>${c}</option>`
      ).join('')}
    </select>
    
    <input type="number" class="ord-qty p-2 border rounded col-span-1 lg:col-span-1" placeholder="Qty" value="${qty}">
    <input class="ord-unit p-2 border rounded col-span-1 lg:col-span-1" placeholder="Unit" value="${unit}">
    
    <input type="number" class="ord-rate p-2 border rounded col-span-2 sm:col-span-1 lg:col-span-1" placeholder="Rate" value="${rate}">
    
    <div class="flex items-center justify-between col-span-2 sm:col-span-3 lg:col-span-1"> 
        <span class="ord-amt font-semibold text-right pr-2">${amount}</span>
        <button class="smallbtn bg-red-500 text-white" onclick="this.closest('.order-row').remove()">‚úï</button>
    </div>
  `;
  // ... (‡§¨‡§æ‡§ï‡•Ä‡§ö‡§æ calcAmount logic ‡§ú‡§∏‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§§‡§∏‡§æ ‡§†‡•á‡§µ‡§æ)

  const qtyInput = row.querySelector('.ord-qty');
  const rateInput = row.querySelector('.ord-rate');
  const amtSpan = row.querySelector('.ord-amt');

  function calcAmount() {
    const q = parseFloat(qtyInput.value) || 0;
    const r = parseFloat(rateInput.value) || 0;
    amtSpan.textContent = (q * r).toFixed(2);
  }

  qtyInput.addEventListener('input', calcAmount);
  rateInput.addEventListener('input', calcAmount);

  parent.appendChild(row);
}


// ‚úÖ SAVE function (Category per item save ‡§π‡•ã‡§à‡§≤)
function saveOrder() {
  const date = el('ord-date').value;
  const client = el('ord-client').value.trim();
  const work = el('ord-work').value.trim();
  const status = el('order-status').value.trim();
  const invoiceId = el('order-invoice-select').value.trim();
  const merchantName = el('merchant-name').value.trim();
  const merchantContact = el('merchant-contact').value.trim();
  const paymentStatus = el('payment-status').value.trim();

  if (!invoiceId) return alert("‡§ï‡•É‡§™‡§Ø‡§æ Invoice No ‡§®‡§ø‡§µ‡§°‡§æ.");
  if (!client) return alert("‡§ï‡•É‡§™‡§Ø‡§æ Client Name ‡§≤‡§ø‡§π‡§æ.");

  const items = [];
  document.querySelectorAll('#order-items > .order-row').forEach(r => {
    const part = r.querySelector('.ord-part').value.trim();
    const category = r.querySelector('.ord-category').value.trim();
    const qty = parseFloat(r.querySelector('.ord-qty').value) || 0;
    const unit = r.querySelector('.ord-unit').value.trim();
    const rate = parseFloat(r.querySelector('.ord-rate').value) || 0;
    const amount = parseFloat(r.querySelector('.ord-amt').textContent) || 0;

    if (part) items.push({ part, category, qty, unit, rate, amount: amount.toFixed(2) });
  });

  if (!items.length) return alert("‡§ï‡§Æ‡•Ä‡§§ ‡§ï‡§Æ‡•Ä ‡§è‡§ï item add ‡§ï‡§∞‡§æ.");

  let id = selectedOrderId;
  if (!id || !id.startsWith("ORD-")) {
    id = getNextOrderId();
}


  const rec = {
    id, date, client, work, status, invoiceId,
    merchantName, merchantContact, paymentStatus, items
  };

  const idx = DATA.orders.findIndex(o => o.id === id);
  if (idx !== -1) {
    DATA.orders[idx] = rec;
    alert("‡§ë‡§∞‡•ç‡§°‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ù‡§æ‡§≤‡•Ä ‚úÖ: " + id);
  } else {
    DATA.orders.push(rec);
    alert("‡§ë‡§∞‡•ç‡§°‡§∞ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•Ä ‚úÖ: " + id);
  }

  selectedOrderId = null;
  saveData();
  syncReceivedOrdersToExpensesCombined();
  renderOrders();

  // form clear
  el('ord-client').value = '';
  el('ord-work').value = '';
  el('order-items').innerHTML = '';
  el('merchant-name').value = '';
  el('merchant-contact').value = '';
}

function renderOrders() {
    const box = el('saved-orders');
    if (!box) return;
    box.innerHTML = '';
    
    (DATA.orders || []).sort((a, b) => b.id.localeCompare(a.id)).forEach(r => {
        const div = document.createElement('div');
        div.className = "p-2 border rounded bg-gray-700 mb-1 text-sm";
        const totalAmount = r.items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);

        let html = `
            <div class="font-bold text-lg text-yellow-400">
                ${r.id} | ${formatDateToInput(r.date)} | ${r.client || ''} | ${r.work || ''}
            </div>
            <div class="text-white">
                Invoice: ${r.invoiceId || 'N/A'} | Status: ${r.status || 'N/A'} 
                | Merchant: ${r.merchantName || 'N/A'} | Payment: ${r.paymentStatus || 'N/A'}
                | Total: ‚Çπ${totalAmount.toFixed(2)}
            </div>
            <ul class="list-disc list-inside ml-4 text-xs mt-1">
        `;

        r.items.forEach(it => {
            html += `
                <li>${it.part} - ${it.qty} ${it.unit} @ ‚Çπ${it.rate} = ‚Çπ${it.amount}</li>
            `;
        });
        
        html += `
            </ul>
            <div class="flex gap-2 mt-2"> 
                <button class="smallbtn" onclick="loadOrder('${r.id}')">Load</button> 
                <button class="smallbtn" onclick="shareOrder('${r.id}')">Share</button> 
                <button class="smallbtn bg-red-500" onclick="deleteOrder('${r.id}')">Delete</button> 
            </div>
        `;
        div.innerHTML = html;
        box.appendChild(div);
    });
}

// ‚úÖ LOAD function (Category per item load ‡§π‡•ã‡§à‡§≤)
function loadOrder(id) {
  const rec = (DATA.orders || []).find(x => x.id === id);
  if (!rec) return alert("Order not found!");

  selectedOrderId = id;
  show('orders');

  el('ord-date').value = formatDateToInput(rec.date);
  el('ord-client').value = rec.client || '';
  el('ord-work').value = rec.work || '';
  el('order-status').value = rec.status || '';
  el('order-invoice-select').value = rec.invoiceId || '';
  el('merchant-name').value = rec.merchantName || '';
  el('merchant-contact').value = rec.merchantContact || '';
  el('payment-status').value = rec.paymentStatus || '';

  el('order-items').innerHTML = '';
  (rec.items || []).forEach(it => addOrderRow(it));
}

function shareOrder(orderId) {
    const c = DATA.company || {};
    const cname = c.name || "Vaibhav Enterprises";
    
    const r = DATA.orders.find(o => o.id === orderId);
    if (!r) { alert("Record not found for sharing"); return; }
    
    const lines = [];
    lines.push('üì¶ Order Details');
    lines.push('');
    lines.push('*' + cname + '*');
    lines.push('');
    lines.push('Order ID: ' + r.id);
    lines.push('Order Date: ' + new Date(r.date).toLocaleDateString());
    lines.push('Order Status: *' + r.status + '*');

    // üî• ‡§ú‡§∞ Status = "order" ‡§Ö‡§∏‡•á‡§≤ ‚Üí Payment Status ‡§ö‡•Ä ‡§ì‡§≥ ‡§ü‡§æ‡§ï‡•Ç ‡§®‡§ï‡§æ
    const hideDetails = (r.status?.toLowerCase() === "order");

    if (!hideDetails) {
        lines.push('Payment Status: *' + r.paymentStatus + '*');
    }

    // merchant ‡§≤‡§æ‡§á‡§® ‡§ï‡§æ‡§Ø‡§Æ ‡§†‡•á‡§µ‡§æ‡§Ø‡§ö‡•Ä
    lines.push('Merchant: ' + (r.merchantName || 'N/A') + ' (' + (r.merchantContact || 'N/A') + ')');
    lines.push('');
    lines.push('Items:');

    // üî• "order" status ‚Üí Rate ‡§Ü‡§£‡§ø Amount ‡§®‡§ï‡•ã
    (r.items || []).forEach(it => {
        if (hideDetails) {
            lines.push(`‚Ä¢ ${it.part} | Qty: ${it.qty} ${it.unit}`);
        } else {
            lines.push(`‚Ä¢ ${it.part} | Qty: ${it.qty} ${it.unit} | Rate: ‚Çπ${it.rate} | Amt: ‚Çπ${it.amount}`);
        }
    });

    // üî• Total amount ‡§´‡§ï‡•ç‡§§ Status ‚â† "order" ‡§Ö‡§∏‡§§‡§æ‡§®‡§æ
    if (!hideDetails) {
        const totalAmount = r.items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
        lines.push('');
        lines.push('*Order Total: ‚Çπ' + totalAmount.toFixed(2) + '*');
    }

    lines.push('');
    lines.push('_Thank you ! / Regards, ' + cname + '_');

    window.open('https://wa.me/?text=' + encodeURIComponent(lines.join('\n')), '_blank');
}



function syncReceivedOrdersToExpensesCombined() {
  (DATA.orders || []).forEach(order => {
    const orderItems = order.items || [];

    // --- ‡§´‡§ï‡•ç‡§§ received ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á orders sync ‡§ï‡§∞ ---
    if (order.status === "received" && order.invoiceId) {
      const invoiceNo = order.invoiceId;

      // üîç ‡§Ü‡§ß‡•Ä‡§™‡§æ‡§∏‡•Ç‡§® Expense entry ‡§Ü‡§π‡•á ‡§ï‡§æ ‡§§‡•á ‡§¨‡§ò‡§æ
      let existing = DATA.expenses.find(e => e.invoiceNo === invoiceNo);

      // --- Order ‡§Æ‡§ß‡•Ä‡§≤ ‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ï‡•ç‡§ï‡§Æ ---
      const totalAmt = orderItems.reduce((sum, it) => sum + (parseFloat(it.amount) || 0), 0);

      // --- ‡§®‡§µ‡•Ä‡§® ‡§°‡•á‡§ü‡§æ ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ ---
      const newData = {
        date: order.date || new Date().toISOString().slice(0, 10),
        // ‚úÖ ‡§ú‡§∞ ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§Ü‡§Ø‡§ü‡§Æ‡§≤‡§æ category ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§§‡•ç‡§Ø‡§æ‡§§‡•Ç‡§® ‡§µ‡§æ‡§™‡§∞
        category: order.category || "Order Material",
        items: orderItems.map(it => ({
          name: it.name || it.part || "Unnamed",
          qty: it.qty || it.quantity || 0,
          unit: it.unit || "-",
          rate: it.rate || 0,
          amount: parseFloat(it.amount) || ((parseFloat(it.qty) || 0) * (parseFloat(it.rate) || 0)),
          category: it.category || order.category || "Order Material"  // ‚úÖ ‡§®‡§µ‡•Ä‡§® ‡§ì‡§≥
        }))
      };

      // --- Merge Logic (Duplicate check ‡§∏‡§π‡§ø‡§§) ---
      if (existing) {
        const existingNames = existing.name.split(',').map(s => s.trim().toLowerCase());
        const existingQtys = existing.quantity.split(',').map(s => s.trim());
        const existingUnits = existing.unit.split(',').map(s => s.trim());
        const existingRates = existing.rate.split(',').map(s => s.trim());
        const existingCats = existing.category.split(',').map(s => s.trim());
        const existingDates = existing.date.split(',').map(s => s.trim());

        newData.items.forEach(it => {
    const lowerName = it.name.trim().toLowerCase();

    const alreadyExists =
        existingNames.includes(lowerName) &&
        existingQtys.includes(String(it.qty)) &&
        existingRates.includes(String(it.rate)) &&
        existingDates.includes(newData.date);

    if (!alreadyExists) {
        existingNames.push(lowerName);
        existingQtys.push(it.qty);
        existingUnits.push(it.unit);
        existingRates.push(it.rate);
        existingCats.push(it.category || newData.category);
        existingDates.push(newData.date);
    }
});


        // --- ‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§Æ‡•ã‡§ú‡§æ ---
        const allAmounts = [];
        for (let i = 0; i < existingNames.length; i++) {
          const rate = parseFloat(existingRates[i]) || 0;
          const qty = parseFloat(existingQtys[i]) || 0;
          allAmounts.push(rate * qty);
        }

        existing.name = existingNames.join(', ');
        existing.quantity = existingQtys.join(', ');
        existing.unit = existingUnits.join(', ');
        existing.rate = existingRates.join(', ');
        existing.category = existingCats.join(', ');
        existing.date = existingDates.join(', ');
        existing.amount = allAmounts.reduce((sum, a) => sum + a, 0).toFixed(2);

      } else {
        // ‚ûï ‡§®‡§µ‡•Ä‡§® Expense ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ
        DATA.expenses.push({
    id: 'EXP-' + String(++DATA.counters.exp).padStart(6, '0'),
    invoiceNo,
    date: newData.date,
    category: newData.items.map(i => i.category).join(', '),
    name: newData.items.map(i => i.name).join(', '),
    quantity: newData.items.map(i => i.qty).join(', '),
    unit: newData.items.map(i => i.unit).join(', '),
    rate: newData.items.map(i => i.rate).join(', '),
    amount: totalAmt.toFixed(2),
    source: "order",
    orderId: order.id  // üëà MOST IMPORTANT
});

      }
    }

    // --- ‡§ú‡§∞ Order delete, cancel ‡§ï‡§ø‡§Ç‡§µ‡§æ returned ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§§‡•ç‡§Ø‡§æ‡§ö‡§Ç Expense ‡§ï‡§æ‡§¢‡§æ ---
    else if (["Order", "deleted", "cancelled", "returned"].includes(order.status) && order.invoiceId) {
      const invoiceNo = order.invoiceId;

      // ‚úÖ ‡§´‡§ï‡•ç‡§§ ‡§§‡•ç‡§Ø‡§æ invoiceNo ‡§∏‡§æ‡§†‡•Ä ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á order-generated expense ‡§ï‡§æ‡§¢‡•Ç‡§® ‡§ü‡§æ‡§ï‡§æ
      DATA.expenses = DATA.expenses.filter(e => !(e.invoiceNo === invoiceNo && e.source === 'order'));
    }
  });

  saveData();
  renderExpensesList();
}





function deleteOrder(id) {
  const ord = DATA.orders.find(o => o.id === id);
  if (!ord) return alert("Order not found.");

  if (!confirm(`Are you sure you want to delete Order ${id}?`)) return;

  // 1) Remove order
  DATA.orders = DATA.orders.filter(o => o.id !== id);

  // 2) Remove ONLY expenses created by THIS ORDER
  DATA.expenses = DATA.expenses.filter(e => e.orderId !== id);

  saveData();
  alert(`Order ${id} and related Expenses deleted.`);
  
  renderOrdersList?.();
  renderExpensesList?.();
}




// üëâ ‡§á‡§•‡•á importMaterialList() ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞
function importMaterialList(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.xlsx';

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      const wb = XLSX.read(ev.target.result, { type: 'binary' });
      const ws = wb.Sheets['Item'];
      if (!ws) return alert("No 'Item' sheet found in file");

      const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
      DATA.materials = [];

      rows.forEach(r => {
        const part = (r[0] || '').trim();
        const unit = (r[1] || '').trim();
        if (part) {
          DATA.materials.push({ part, unit });
        }
      });

      saveData();
      refreshMaterialsDatalist();  // ‚úÖ HIGHLIGHTED
      renderMaterialsDropdown();   // (optional, if you're using dropdown somewhere)
      alert("Item list (with Units) imported ‚úÖ");
    };

    reader.readAsBinaryString(file);
  };

  input.click();
}




function renderMaterialsDropdown() {
  const datalist = document.getElementById("materials");
  if (!datalist) return;

  datalist.innerHTML = '';
  (DATA.materials || []).forEach(mat => {
    const opt = document.createElement("option");
    opt.value = mat.part;
    datalist.appendChild(opt);
  });
}


function getNextOrderId() {
  let used = DATA.orders.map(o => Number(o.id.replace("ORD-", "")));

  let n = 1;
  while (used.includes(n)) n++;

  return "ORD-" + String(n).padStart(4, "0");
}


/* -------------------------------------------------------------
 * 6Ô∏è‚É£ PAYMENTS (Received Payments) (Local Storage Implementation)
 * ------------------------------------------------------------- */
function addPaymentRowForm(data = {}) {
    const parent = el('payment-rows');
    const row = document.createElement('div');
    row.className = 'payment-row p-3 border rounded bg-gray-700 grid grid-cols-4 gap-2 text-sm';
    row.innerHTML = `
        <input type="date" class="pay-date w-full col-span-1" placeholder="Date" value="${data.date || new Date().toISOString().slice(0, 10)}">
        <input type="number" class="pay-recv w-full col-span-1" placeholder="Received Amt (‚Çπ)" value="${data.received || ''}">
        <input type="text" class="pay-note w-full col-span-2" placeholder="Note (e.g. Cash, GPay, Bank)" value="${data.note || ''}">
        <button class="smallbtn bg-red-500 col-span-1" onclick="this.closest('.payment-row').remove()">‚úï</button>
    `;
    parent.appendChild(row);
}

function handleInvoiceSelectInPayment(invNo) {
    const inv = DATA.invoices.find(i => i.id === invNo);
    const cost = parseFloat(inv?.grandTotal) || 0;
    
    // Load Invoice Details
    el('pay-client').value = inv?.client || '';
    el('pay-contact').value = inv?.contact || '';
    el('pay-work').value = inv?.work || '';
    el('pay-cost').value = cost.toFixed(2);
    
    // Load existing payments for this invoice
    const recs = DATA.payments.filter(p => p.invoiceNo === invNo);
    el('payment-rows').innerHTML = ''; // Clear existing rows
    
    if(recs.length > 0) {
        // Since payments are individual entries, we filter by invoiceNo.
        recs.forEach(p => addPaymentRowForm(p));
    } else {
        addPaymentRowForm(); // Add one empty row if none exist
    }
}


function savePayments() {
    const invNo = el('pay-invno').value.trim();
    const client = el('pay-client').value.trim();
    const contact = el('pay-contact').value.trim();
    const work = el('pay-work').value.trim();
    const projectCost = parseFloat(el('pay-cost').value) || 0;
    
    if (!invNo) return alert("Please select Invoice No. and then save.");
    if (!client) return alert("Enter Client Name");

    const newEntries = [];
    document.querySelectorAll('#payment-rows .payment-row').forEach(r => {
        const date = r.querySelector('.pay-date').value || new Date().toISOString().split('T')[0];
        const received = parseFloat(r.querySelector('.pay-recv').value) || 0;
        const note = r.querySelector('.pay-note').value || '';
        if (received > 0 || note) newEntries.push({ date, received, note });
    });

    if (newEntries.length === 0) return alert('Add at least one payment entry (Received Amount > 0)');

    // 1. Delete all existing payments for this invoice in the local DATA
    DATA.payments = DATA.payments.filter(p => p.invoiceNo !== invNo);
    
    let id;
    // Check if an ID was previously used for this Invoice, if not, generate new ID
    // Note: The Payment ID is typically per Invoice, not per transaction row.
    const maxPaymentGroupNum = DATA.payments.reduce((max, p) => {
        const num = parseInt(p.id.replace('PAY-', '')) || 0;
        return Math.max(max, num);
    }, DATA.counters.pay);
    
    DATA.counters.pay = maxPaymentGroupNum + 1;
    id = 'PAY-' + String(DATA.counters.pay).padStart(4,'0');
    
    // 2. Add new entries with the new ID (or existing ID if there was a group before deletion, though the previous delete step handles the clearing)
    newEntries.forEach((en, i) => {
        // For simplicity, we assign a unique ID to the entire group/invoice set in Payments.
        // If we want each row to be independent (like Expenses), we need a different ID generation.
        // Sticking to original logic: The ID is the 'grouping' ID.
        const record = { 
            id: invNo, // Using Invoice No as the grouping ID for simplicity and connection
            client, 
            contact, 
            work, 
            invoiceNo: invNo, 
            projectCost: i===0 ? projectCost : 0, 
            date: en.date, 
            received: en.received, 
            note: en.note 
        };
        DATA.payments.push(record);
    });

    saveData(); 
    alert("Payments saved/updated for Invoice: " + invNo);

    // Clear form
    el('payment-rows').innerHTML = '';
    addPaymentRowForm();
}


function renderPaymentsList() {
    const box = el('saved-payments');
    if (!box) return;
    box.innerHTML = '';
    
    // Group payments by Invoice No (which serves as the group ID)
    const groups = DATA.payments.reduce((acc, p) => {
        const id = p.invoiceNo || 'N/A';
        if (!acc[id]) acc[id] = [];
        acc[id].push(p);
        return acc;
    }, {});
    
    Object.keys(groups).sort((a, b) => b.localeCompare(a)).forEach(invNo => {
        const recs = groups[invNo];
        const base = recs[0];
        const projectCost = parseFloat(base.projectCost) || 0;
        const totalReceived = recs.reduce((s, x) => s + (parseFloat(x.received) || 0), 0);
        const balance = projectCost - totalReceived;

        const div = document.createElement('div');
        div.className = "p-3 border rounded bg-gray-700 mb-1 text-sm";
        
        let html = `
            <div class="font-bold text-lg text-yellow-400">Invoice: ${invNo}</div>
            <div class="text-white">${base.client} | ${base.work || 'N/A'}</div>
            <div class="font-semibold mt-1">
                Cost: ‚Çπ${money(projectCost)} | Received: ‚Çπ${money(totalReceived)} | 
                <span class="${balance >= 0 ? 'text-green-400' : 'text-red-400'}">Balance: ‚Çπ${money(balance)}</span>
            </div>
            <ul class="list-disc list-inside ml-4 text-xs mt-1">
        `;
        
        recs.forEach(r => {
            html += `
                <li>${formatDateToInput(r.date)}: ‚Çπ${money(r.received)} (${r.note || 'N/A'})</li>
            `;
        });
        
        html += `
            </ul>
            <div class="flex gap-2 mt-2">
                <button class="smallbtn" onclick="loadPayment('${invNo}')">Load</button>
                <button class="smallbtn" onclick="sharePayment('${invNo}')">Share</button>
                <button class="smallbtn bg-red-500" onclick="deletePayment('${invNo}')">Delete All</button>
            </div>
        `;
        div.innerHTML = html;
        box.appendChild(div);
    });
}

function loadPayment(invNo) {
    const recs = DATA.payments.filter(p => p.invoiceNo === invNo);
    if(recs.length === 0) return alert('Payment records not found for this invoice.');

    const r0 = recs[0];
    show('payments');
    
    el('pay-invno').value = invNo;
    el('pay-client').value = r0.client || '';
    el('pay-contact').value = r0.contact || '';
    el('pay-work').value = r0.work || '';
    el('pay-cost').value = (parseFloat(r0.projectCost) || 0).toFixed(2);
    
    el('payment-rows').innerHTML = '';
    recs.forEach(p => addPaymentRowForm(p));
}

function deletePayment(invNo) {
    if (!confirm("Are you sure you want to delete ALL payment records for Invoice " + invNo + "?")) return;
    DATA.payments = DATA.payments.filter(p => p.invoiceNo !== invNo);
    saveData();
    alert(`All payments for Invoice ${invNo} deleted.`);
}

function sharePayment(invNo) {
    // --- COMPANY INFO (navin add kele) ---
    const c = DATA.company || {};
    const cname = c.name || "Vaibhav Enterprises"; // Company name dynamically get kela
    const cwebsite = (c.website && c.website.trim() !== "") ? c.website.trim() : "";
    
    const recs = DATA.payments.filter(x => x.invoiceNo === invNo);
    if (!recs.length) return;

    const base = recs[0];
    const projectCost = parseFloat(base.projectCost) || 0;
    const totalReceived = recs.reduce((s, x) => s + (parseFloat(x.received) || 0), 0);
    const balance = projectCost - totalReceived;

    let lines = [
        'üìÑRecive Payment Receipt',
        '',
        'Customer: ' + base.client,
        'Contact: ' + (base.contact || ''),
        'Work Title: ' + (base.work || ''),
        'Project Cost: ‚Çπ' + money(projectCost),
        '',
        // NOTE: Tumchya original code madhye date formatting function 'formatDateToInput' missing ahe, 
        // pan mi to tewdhach thevat ahe.
        'S.No | Date | Amt | Type', 
        '------------------------------------'
    ];

    recs.forEach((r, i) => {
        const date = formatDateToInput(r.date);
        const amount = '‚Çπ' + money(r.received);
        const type = r.note || 'Cash';
        lines.push(`${i + 1} | ${date} | ${amount} | ${type}`);
    });

    lines.push('------------------------------------');
    lines.push('');
    lines.push('*Total Received: ‚Çπ' + money(totalReceived) + '*');
    lines.push('*Balance: ‚Çπ' + money(balance) + '*');
    lines.push('');
    
    // ‚úÖ Company name 'cname' vaparla
    lines.push(cname);
    
    // ‚úÖ Jar website ahe tarach line add keli
    if (cwebsite) {
        lines.push(cwebsite); 
    }

    window.open('https://wa.me/?text=' + encodeURIComponent(lines.join('\n')), '_blank');
}

/* -------------------------------------------------------------
 * 7Ô∏è‚É£ PAID PAYMENTS (Local Storage Implementation)
 * ------------------------------------------------------------- */

// üîÑ Order ID ‡§®‡§ø‡§µ‡§°‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ Paid Payment ‡§´‡•Ä‡§≤‡•ç‡§° Auto Fill ‡§π‡•ã‡§§‡§æ‡§§
document.getElementById("pp-order-id").addEventListener("change", function () {
  const orderId = this.value.trim();
  if (!orderId) return;

  const ord = (DATA.orders || []).find(o => o.id === orderId);
  if (!ord) return alert("Order not found for " + orderId);

  // ‚úÖ Name Field ‚Üí Merchant Name + Contact + Date
  const ordDate = ord.date ? ord.date.split("-").reverse().join("-") : "";
  const nameDisplay = `${ord.merchantName || "N/A"} - ${ord.merchantContact || "N/A"} - ${ordDate}`;
  el("pp-name").value = nameDisplay;

  // ‚úÖ Labor / Contractor ‚Üí Category
  el("pp-labor").value = ord.category || "";

  // ‚úÖ Paid Amount ‚Üí Total of Order Items
  const totalAmt = (ord.items || []).reduce((sum, it) => sum + (parseFloat(it.amount) || 0), 0);

  // ‡§ú‡§∞ payment row ‡§®‡§∏‡•á‡§≤, ‡§§‡§∞ ‡§è‡§ï add ‡§ï‡§∞‡§æ
  if (!document.querySelector("#pp-rows .pp-row")) {
    addPaidRow();
  }

  // ‡§Ü‡§§‡§æ ‡§™‡§π‡§ø‡§≤‡§æ row ‡§™‡§ï‡§°‡•Ç‡§® ‡§§‡•ç‡§Ø‡§æ‡§§ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§≠‡§∞‡§æ
  const firstRow = document.querySelector("#pp-rows .pp-row");
  if (firstRow) {
    const amtInput = firstRow.querySelector(".pp-amount");
    const noteInput = firstRow.querySelector(".pp-note");

    if (amtInput) amtInput.value = totalAmt.toFixed(2);

    // ‚úÖ Purpose / Note ‚Üí Items + Qty
    const itemNotes = (ord.items || [])
      .map(it => `${it.part || it.name || "Item"} ${it.qty || 0} ${it.unit || ""}`)
      .join(", ");
    if (noteInput) noteInput.value = itemNotes;
  }
});



function addPaidRow(data = {}) {
    const parent = el('pp-rows');
    const row = document.createElement('div');
    row.className = 'pp-row p-3 border rounded bg-gray-700 grid grid-cols-5 gap-2 text-sm items-center';
    row.innerHTML = `
        <input type="date" class="pp-date w-full col-span-1" placeholder="Date" value="${data.date || new Date().toISOString().slice(0, 10)}">
        <input type="number" class="pp-amount w-full col-span-1" placeholder="Paid Amt (‚Çπ)" value="${data.amount || ''}">
        <input type="text" class="pp-note w-full col-span-2" placeholder="Purpose / Note" value="${data.note || ''}">
        <button class="smallbtn bg-red-500 col-span-1" onclick="this.closest('.pp-row').remove()">‚úï</button>
    `;
    parent.appendChild(row);
}

function handleInvoiceSelectInPaid(invNo) {
    const inv = DATA.invoices.find(i => i.id === invNo);
    el('pp-client').value = inv?.client || '';
    el('pp-work').value = inv?.work || '';
}

function savePaidPayment() {
    const invNo = el('pp-invno').value.trim();
    const orderId = el('pp-order-id').value.trim();
    const client = el('pp-client').value.trim();
    const work = el('pp-work').value.trim();
    const name = el('pp-name').value.trim();
    const labor = el('pp-labor').value.trim();

    if (!invNo && !orderId) return alert("Please select Invoice No. or Order ID.");
    if (!name && !labor) return alert("Enter Name or Labor/Contractor.");

    const newEntries = [];
    document.querySelectorAll('#pp-rows .pp-row').forEach(r => {
        const date = r.querySelector('.pp-date').value || new Date().toISOString().split('T')[0];
        const amount = parseFloat(r.querySelector('.pp-amount').value) || 0;
        const note = r.querySelector('.pp-note').value || '';
        if (amount > 0 || note) newEntries.push({ date, amount, note });
    });

    if (newEntries.length === 0) return alert('Add at least one payment entry (Amount > 0)');
    
    // üí° ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä: ‡§ú‡•Å‡§®‡•á ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§°‡§ø‡§≤‡§ø‡§ü ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§Ö‡§ü
    if (orderId && orderId !== 'N/A' && orderId !== '') {
        // ‡§ï‡•á‡§∏ 1: Order ID ‡§Ö‡§∏‡•á‡§≤, ‡§§‡§∞ ‡§´‡§ï‡•ç‡§§ Order ID ‡§Ü‡§£‡§ø Invoice ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§°‡§ø‡§≤‡§ø‡§ü ‡§ï‡§∞‡§æ. (‡§§‡•Å‡§Æ‡§ö‡§æ ‡§ú‡•Å‡§®‡§æ ‡§®‡§ø‡§Ø‡§Æ)
        DATA.paidPayments = DATA.paidPayments.filter(pp => !(pp.invoiceNo === invNo && pp.orderId === orderId));
    } else {
        // ‡§ï‡•á‡§∏ 2: Order ID ‡§®‡§∏‡•á‡§≤ (‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä), ‡§§‡§∞ Invoice No. ‡§Ü‡§£‡§ø Name/Labor ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§°‡§ø‡§≤‡§ø‡§ü ‡§ï‡§∞‡§æ.
        // ‡§Ø‡§æ‡§Æ‡•Å‡§≥‡•á Rohan ‡§ö‡•Ä ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä Santosh ‡§ö‡•ç‡§Ø‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§®‡•á ‡§∞‡§ø‡§™‡•ç‡§≤‡•á‡§∏ ‡§π‡•ã‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä.
        DATA.paidPayments = DATA.paidPayments.filter(pp => !(
            pp.invoiceNo === invNo && 
            (!pp.orderId || pp.orderId === 'N/A') && 
            pp.name === name && 
            pp.labor === labor
        ));
    }

    // ID ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§Ü‡§£‡§ø ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§™‡•Å‡§∂‡§ø‡§Ç‡§ó (‡§§‡•Å‡§Æ‡§ö‡•á ‡§ï‡§æ‡§≤‡§ö‡•á ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§ ‡§ï‡•á‡§≤‡•á‡§≤‡•á ‡§ï‡•ã‡§°)
    newEntries.forEach(en => {
        DATA.counters.pp = (DATA.counters.pp || 0) + 1;
        const id = 'PP-' + String(DATA.counters.pp).padStart(6, '0'); 
        
        const record = {¬†
            id: id,
            invoiceNo: invNo,¬†
            orderId: orderId || 'N/A', // ‡§ë‡§∞‡•ç‡§°‡§∞ ID ‡§®‡§∏‡•á‡§≤ ‡§§‡§∞ 'N/A' ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ
            client,¬†
            work,¬†
            name,¬†
            labor,
            date: en.date,¬†
            amount: en.amount.toFixed(2),¬†
            note: en.note¬†
        };
        DATA.paidPayments.push(record);
    });

    saveData();¬†
    alert(`Paid Payments saved/updated for: ${invNo || orderId}`);

    // Order ID ‡§∏‡§æ‡§†‡•Ä Payment Status "Paid" ‡§ï‡§∞‡§æ (‡§π‡§æ ‡§≠‡§æ‡§ó ‡§ú‡§∏‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§§‡§∏‡§æ ‡§†‡•á‡§µ‡§æ)
    if (orderId && orderId !== "N/A") {
      const ord = (DATA.orders || []).find(o => o.id === orderId);
      if (ord) {
        ord.paymentStatus = "Paid";
        saveData();
        renderOrders();
      }
    }

    // Clear form rows 
    el('pp-rows').innerHTML = '';
    addPaidRow();
    renderPaidPayments(); 
}

function renderPaidPayments() {
    const box = el('saved-paid');
    if (!box) return;
    box.innerHTML = '';
    
    // Group payments by a composite key (InvoiceNo_OrderId)
    const groups = DATA.paidPayments.reduce((acc, pp) => {
        let key;
        
        // üí° ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä: ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä (Order ID ‡§®‡§∏‡•á‡§≤ ‡§§‡•á‡§µ‡•ç‡§π‡§æ) Name ‡§Ü‡§£‡§ø Labor ‡§ö‡§æ ‡§µ‡§æ‡§™‡§∞ Key ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ï‡§∞‡§æ.
        if (!pp.orderId || pp.orderId === 'N/A' || pp.orderId === '') {
            // New Key Format: InvNo^N/A^Name^Labor (separating manual payments)
            // ' ^ ' ‡§ö‡§æ ‡§µ‡§æ‡§™‡§∞ ‡§ï‡•á‡§≤‡§æ ‡§Ü‡§π‡•á ‡§ú‡•á‡§£‡•á‡§ï‡§∞‡•Ç‡§® _ ‡§∏‡•ã‡§¨‡§§ ‡§ó‡•ã‡§Ç‡§ß‡§≥ ‡§π‡•ã‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä.
            key = `${pp.invoiceNo || 'N/A'}^N/A^${pp.name || 'MANUAL'}^${pp.labor || 'N/A'}`; 
        } else {
            // Standard Key Format: InvNo_OrderId
            key = `${pp.invoiceNo || 'N/A'}_${pp.orderId || 'N/A'}`;
        }
        
        if (!acc[key]) acc[key] = [];
        acc[key].push(pp);
        return acc;
    }, {});
    
    Object.keys(groups).sort((a, b) => b.localeCompare(a)).forEach(key => {
        const recs = groups[key];
        const base = recs[0];
        const totalPaid = recs.reduce((s, x) => s + (parseFloat(x.amount) || 0), 0);

        const div = document.createElement('div');
        div.className = "p-3 border rounded bg-gray-700 mb-1 text-sm";
        
        let html = `
            <div class="font-bold text-lg text-yellow-400">
                Invoice: ${base.invoiceNo || 'N/A'} | Order: ${base.orderId || 'N/A'}
            </div>
            <div class="text-white">${base.name} (${base.labor || 'Self'}) | ${base.client} - ${base.work || 'N/A'}</div>
            <div class="font-semibold mt-1">Total Paid: ‚Çπ${money(totalPaid)}</div>
            <ul class="list-disc list-inside ml-4 text-xs mt-1">
        `;
        
        recs.forEach(r => {
            html += `
                <li>${formatDateToInput(r.date)}: ‚Çπ${money(r.amount)} (${r.note || 'N/A'})</li>
            `;
        });
        
        html += `
            </ul>
            <div class="flex gap-2 mt-2">
                <button class="smallbtn" onclick="loadPaidPayment('${key}')">Load</button>
                <button class="smallbtn" onclick="sharePaidPayment('${key}')">Share</button>
                <button class="smallbtn bg-red-500" onclick="deletePaidPayment('${key}')">Delete All</button>
            </div>
        `;
        div.innerHTML = html;
        box.appendChild(div);
    });
}


function loadPaidPayment(key) {
    let recs;
    
    if (key.includes('^N/A^')) {
        // üí° ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä: ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä Key Parsing
        // Key Format: InvNo^N/A^Name^Labor
        const parts = key.split('^');
        const invNo = parts[0];
        const name = parts[2];
        const labor = parts[3];
        
        recs = DATA.paidPayments.filter(pp => 
            pp.invoiceNo === invNo && 
            (!pp.orderId || pp.orderId === 'N/A' || pp.orderId === '') && 
            pp.name === name && 
            pp.labor === labor
        );
        
        el('pp-order-id').value = ''; // Order ID clear ‡§ï‡§∞‡§æ

    } else {
        // Standard Key Parsing
        const [invNo, orderId] = key.split('_');
        recs = DATA.paidPayments.filter(pp => pp.invoiceNo === invNo && pp.orderId === orderId);
        el('pp-order-id').value = orderId;
    }
    
    if(recs.length === 0) return alert('Paid Payment records not found.');

    const r0 = recs[0];
    show('paid');
    
    el('pp-invno').value = r0.invoiceNo;
    el('pp-client').value = r0.client || '';
    el('pp-work').value = r0.work || '';
    el('pp-name').value = r0.name || '';
    el('pp-labor').value = r0.labor || '';
    
    el('pp-rows').innerHTML = '';
    recs.forEach(p => addPaidRow(p));
}

function deletePaidPayment(key) {
    if (!confirm("Are you sure you want to delete ALL paid payment records for this group?")) return;
    
    if (key.includes('^N/A^')) {
        // üí° ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä: ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä Key Parsing ‡§Ü‡§£‡§ø Deletion
        // Key Format: InvNo^N/A^Name^Labor
        const parts = key.split('^');
        const invNo = parts[0];
        const name = parts[2];
        const labor = parts[3];

        DATA.paidPayments = DATA.paidPayments.filter(pp => !(
            pp.invoiceNo === invNo && 
            (!pp.orderId || pp.orderId === 'N/A' || pp.orderId === '') && 
            pp.name === name && 
            pp.labor === labor
        ));

    } else {
        // Standard Deletion
        const [invNo, orderId] = key.split('_');
        DATA.paidPayments = DATA.paidPayments.filter(pp => !(pp.invoiceNo === invNo && pp.orderId === orderId));
    }
    
    saveData();
    alert(`All paid payments for ${key} deleted.`);
    renderPaidPayments(); 
}


// ‚úÖ Corrected Share Function (same message format, group-wise sharing)
function sharePaidPayment(key) {
    // --- COMPANY INFO ---
    const c = DATA.company || {};
    const cname = c.name || "Vaibhav Enterprises";
    
    let invNo, orderId, name, labor;
    let recs;

    // üí° ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä 1: Key Parsing Logic (renderPaidPayments ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•á)
    if (key.includes('^N/A^')) {
        // ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä Key Format: InvNo^N/A^Name^Labor
        const parts = key.split('^');
        invNo = parts[0];
        orderId = 'N/A'; // For display purposes
        name = parts[2];
        labor = parts[3];
        
        // üí° ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä 2: ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§∂‡•ã‡§ß‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞
        recs = (DATA.paidPayments || []).filter(x => 
            x.invoiceNo === invNo && 
            (!x.orderId || x.orderId === 'N/A' || x.orderId === '') &&
            x.name === name && 
            x.labor === labor
        );
        
    } else {
        // Order ID ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§∏‡•ç‡§ü‡§Å‡§°‡§∞‡•ç‡§° ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° Key Format: InvNo_OrderId
        [invNo, orderId] = key.split('_');
        recs = (DATA.paidPayments || []).filter(x => 
            (x.invoiceNo === invNo) && (x.orderId === orderId)
        );
    }

    if (recs.length === 0) {
        return alert("No Paid Payment found for " + key);
    }
    
    // ---------------------------------------------------
    // ‡§Æ‡•á‡§∏‡•á‡§ú ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ (‡§Ü‡§§‡§æ ‡§¶‡•ã‡§®‡•ç‡§π‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞‡§ö‡•ç‡§Ø‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§∏‡§Æ‡§æ‡§® Logic ‡§µ‡§æ‡§™‡§∞‡§§‡§æ ‡§Ø‡•á‡§à‡§≤)
    // ---------------------------------------------------

    const r = recs[0];
    const total = recs.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);

    const lines = [];
    lines.push("üí∂ Paid Payment Details");
    lines.push("");
    lines.push("Paid Payment ID: " + (r.id || "N/A"));
    
    // ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ / ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á
    if (orderId === "N/A" || !orderId || orderId === '') {
        // ‡§Æ‡•Ö‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á
        
        lines.push("Name: " + (r.name || "N/A"));
        lines.push("Purpose: " + (r.labor || "N/A"));
    } else {
        // ‡§ë‡§∞‡•ç‡§°‡§∞ ID ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á
        lines.push("Order: " + (r.orderId || "N/A"));
        lines.push("Name: " + (r.name || "N/A"));
    }
    
    lines.push("");
    lines.push("S.No |    Date    |    Amt    | Note");
    lines.push("------------------------------------");

    recs.forEach((p, i) => {
      const date = p.date ? new Date(p.date).toLocaleDateString("en-CA") : "N/A";
      // float to 2 decimal places ‡§µ‡§æ‡§™‡§∞‡§≤‡§æ
      const amount = "‚Çπ" + (window.money ? money(p.amount) : parseFloat(p.amount).toFixed(2));
      const note = p.note || "N/A";
      const serial = String(i + 1).padEnd(5, " ");
      const dateStr = date.padEnd(10, " ");
      const amtStr = amount.padEnd(9, " ");
      lines.push(`${serial}| ${dateStr} | ${amtStr} | ${note}`);
    });

    lines.push("------------------------------------");
    lines.push("");
    lines.push("üëâ Total Paid: ‚Çπ" + (window.money ? money(total) : total.toFixed(2)));
    lines.push("");
    lines.push("Regards,");
    lines.push(cname);

    const msg = lines.join("\n");
    const url = "https://wa.me/?text=" + encodeURIComponent(msg);
    window.open(url, "_blank");
}






/* -------------------------------------------------------------
 * 8Ô∏è‚É£ DAILY REPORTS (Already using Local Storage, ensuring proper save/render)
 * ------------------------------------------------------------- */

let dailyReportIdToEdit = null;

function addDailyRow(data = {}) {
    const parent = el('daily-rows');
    const row = document.createElement('div');
    row.className = 'daily-row p-3 border rounded bg-gray-700 grid grid-cols-3 gap-2 text-sm';
    row.innerHTML = `
        <input type="text" class="dr-task w-full col-span-3 md:col-span-1" placeholder="Task/Activity" value="${data.task || ''}">
        <input type="number" class="dr-progress w-full col-span-3 md:col-span-1" placeholder="Progress (%)" value="${data.progress || ''}">
        <input type="text" class="dr-note w-full col-span-3 md:col-span-1" placeholder="Notes/Issue" value="${data.note || ''}">
        <button class="smallbtn bg-red-500 col-span-3" onclick="this.closest('.daily-row').remove()">‚úï</button>
    `;
    parent.appendChild(row);
}

function saveDaily() {
    const client = el('dr-client').value.trim();
    const contact = el('dr-contact').value.trim();
    const work = el('dr-work').value.trim();

    if (!client || !work) return alert("Please enter Client Name and Work Title.");

    const items = [];
    document.querySelectorAll('#daily-rows .daily-row').forEach(row => {
        const task = row.querySelector('.dr-task').value.trim();
        const progress = row.querySelector('.dr-progress').value.trim();
        const note = row.querySelector('.dr-note').value.trim();
        if (task) {
            items.push({ task, progress, note });
        }
    });

    if (items.length === 0) return alert("Please add at least one task/activity.");

    DATA.daily = DATA.daily || [];
    const dateKey = new Date().toISOString().slice(0, 10);
    const id = `${client.slice(0, 3).toUpperCase()}-${dateKey.replace(/-/g, '')}`;

    const rec = {
        id: id,
        date: dateKey,
        client: client,
        contact: contact,
        work: work,
        items: items
    };

    // Update or Add
    const existingIndex = DATA.daily.findIndex(r => r.id === id);
    if (existingIndex !== -1) {
        DATA.daily[existingIndex] = rec;
        alert("Daily Report updated: " + id);
    } else {
        DATA.daily.push(rec);
        alert("Daily Report saved: " + id);
    }

    saveData();
    // Clear form rows (keep headers for context)
    el('daily-rows').innerHTML = '';
    addDailyRow();
}

function renderDailyReports() {
    const box = el('saved-daily');
    if (!box) return;
    box.innerHTML = '';

    (DATA.daily || []).sort((a, b) => b.date.localeCompare(a.date)).forEach(r => {
        const div = document.createElement('div');
        div.className = "p-3 border rounded bg-gray-700 mb-1 text-sm";
        
        let html = `
            <div class="font-bold text-lg text-yellow-400">Report: ${r.date} | ${r.client}</div>
            <div class="text-white">Work: ${r.work} | Contact: ${r.contact || 'N/A'}</div>
            <ul class="list-disc list-inside ml-4 text-xs mt-1">
        `;

        r.items.forEach(it => {
            html += `
                <li>${it.task} - ${it.progress}% Complete (${it.note || 'No notes'})</li>
            `;
        });
        
        html += `
            </ul>
            <div class="flex gap-2 mt-2">
                <button class="smallbtn bg-red-500" onclick="deleteDailyReport('${r.id}')">Delete</button>
            </div>
        `;
        div.innerHTML = html;
        box.appendChild(div);
    });
}

function deleteDailyReport(id) {
    if (!confirm("Are you sure you want to delete this Daily Report?")) return;
    DATA.daily = DATA.daily.filter(r => r.id !== id);
    saveData();
    alert("Daily Report deleted.");
}


/* -------------------------------------------------------------
 * 9Ô∏è‚É£ LABOR (Already using Local Storage, ensuring proper save/render)
 * ------------------------------------------------------------- */
function addLabor(pref){
  const parent = el('labor-rows');
  const div = document.createElement('div'); 
  div.className='p-3 border rounded bg-gray-50';

  div.innerHTML = `
    <div class="grid md:grid-cols-5 gap-2">
      <!-- üÜï Invoice No Field Added -->
      <select class="lab-inv p-2 border rounded" onchange="handleLaborInvoiceSelectRow(this)">
        <option value="">-- Select Invoice --</option>
      </select>

      <input class="lab-client p-2 border rounded" placeholder="Client Name">
      <input class="lab-work p-2 border rounded" placeholder="Work Title">
      <input class="lab-name p-2 border rounded" placeholder="Labor Name">

      <div class="flex items-center gap-1">
        <select class="lab-category p-2 border rounded flex-1">
          <option value="">Select</option>
        </select>
        <button type="button" class="smallbtn" onclick="addCategory()">+</button>
        <button type="button" class="smallbtn" onclick="removeCategory()">-</button>
      </div>
    </div>


    <div class="grid md:grid-cols-4 gap-2 mt-2">
      <input class="lab-rate p-2 border rounded" type="number" placeholder="Per day rate">
      <select class="lab-range p-2 border rounded">
        <option value="week">Week</option>
        <option value="2week">2 Week</option>
        <option value="month">Month</option>
        <option value="combine">Combine</option>
      </select>
      <input class="lab-start p-2 border rounded" type="date">
      <input class="lab-end p-2 border rounded" type="date" readonly>
    </div>

    <div class="mt-2 overflow-x-auto">
      <table class="w-full bg-white">
        <thead>
          <tr class="bg-gray-100">
            <th>Date</th>
            <th>Status (P/A/H)</th>
            <th>Advance (‚Çπ)</th>
            <th>Transport (‚Çπ)</th>
          </tr>
        </thead>
        <tbody class="lab-tbody"></tbody>
      </table>
    </div>

    <!-- Totals Labels -->
    <div class="mt-2 text-sm font-semibold space-y-1">
      <div>Total Days: <span class="lab-totdays">0</span></div>
      <div>Total Advance: ‚Çπ<span class="lab-totadv">0</span></div>
      <div>Total Transport: ‚Çπ<span class="lab-tottrans">0</span></div>
      <div>Balance: ‚Çπ<span class="lab-balance">0</span></div>
    </div>

    <div class="flex gap-2 mt-2">
      <button class="smallbtn" onclick="saveLabor(this)">Save</button>
      <button class="smallbtn" onclick="this.closest('.p-3').remove(); resetLaborIds();">Remove</button>
    </div>
  `;

  parent.appendChild(div);

  const start = div.querySelector('.lab-start'), 
        end = div.querySelector('.lab-end'), 
        rangeSel = div.querySelector('.lab-range'),
        tbody = div.querySelector('.lab-tbody');

  // auto rows generate (patched to append, not overwrite)
  function generateRows(){
    if(!start.value) return;

    const parts = start.value.split('-'); 
    const f = new Date(parts[0], parts[1]-1, parts[2]);

    let days = 7; // default week
    if(rangeSel.value === '2week') days = 14;
    if(rangeSel.value === 'combine') days = 30;
    if(rangeSel.value === 'month'){
      const year = f.getFullYear(), month = f.getMonth()+1;
      days = new Date(year, month, 0).getDate() - f.getDate() + 1;
    }

    // ‡§ï‡§ø‡§§‡•Ä rows ‡§Ü‡§ß‡•Ä‡§ö ‡§Ü‡§π‡•á‡§§ ‡§§‡•á check ‡§ï‡§∞‡§æ
    const existing = tbody.querySelectorAll('tr').length;

    for(let i=existing;i<days;i++){
      const d = new Date(f);
      d.setDate(f.getDate() + i);

      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const ds = `${yyyy}-${mm}-${dd}`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ds}</td>
        <td>
          <select class="lab-status">
            <option value=""></option>
            <option value="P">P</option>
            <option value="A">A</option>
            <option value="H">H</option>
          </select>
        </td>
        <td><input type="number" class="p-1 border rounded lab-adv" value="0" min="0"></td>
        <td><input type="number" class="p-1 border rounded lab-trans" value="0" min="0"></td>
      `;
      tbody.appendChild(tr);
    }

    // end date ‡§®‡•á‡§π‡§Æ‡•Ä last row ‡§ö‡§æ date ‡§Ö‡§∏‡•á‡§≤
    if(tbody.querySelectorAll('tr').length > 0){
      const lastRow = tbody.querySelectorAll('tr')[tbody.querySelectorAll('tr').length-1];
      end.value = lastRow.cells[0].textContent;
    }

    updateLaborTotals(div);
  }

  start.addEventListener('change', generateRows);
  rangeSel.addEventListener('change', generateRows);

  // preload if record exists
  if(pref){
    div.querySelector('.lab-client').value = pref.client || '';
    div.querySelector('.lab-work').value = pref.work || '';
    div.querySelector('.lab-name').value = pref.name || '';
    div.querySelector('.lab-rate').value = pref.rate || 0;
    div.querySelector('.lab-category').value = pref.category || '';
    div.querySelector('.lab-start').value = pref.start;
    div.querySelector('.lab-end').value = pref.end || '';
    rangeSel.value = pref.range || 'week';
    div.querySelector('.lab-start').dispatchEvent(new Event('change'));

    setTimeout(()=>{
      const rows = div.querySelectorAll('.lab-tbody tr');
      pref.days.forEach((d,i)=>{
        if(rows[i]){
          rows[i].querySelector('.lab-status').value = d.status||'';
          rows[i].querySelector('.lab-adv').value = d.advance||0;
          rows[i].querySelector('.lab-trans').value = d.transport||0;
        }
      });
      updateLaborTotals(div);
    },200);
  }

  refreshCategoryOptions(div.querySelector('.lab-category'));
    populateLaborInvoiceDropdown(div.querySelector('.lab-inv'));

}


function saveLabor(btn){
  const div = btn.closest('.p-3'); 

  const invSel = div.querySelector('.lab-inv');
  if (invSel && !invSel.options.length) {
    populateLaborInvoiceDropdown(invSel);
  }

  const invno  = invSel?.value || '';  
  const client = div.querySelector('.lab-client').value || 'Unknown';
  const work   = div.querySelector('.lab-work').value || '';
  const name   = div.querySelector('.lab-name').value || 'Unknown';
  const category = div.querySelector('.lab-category').value || '';
  const rate   = parseFloat(div.querySelector('.lab-rate').value)||0;
  const range  = div.querySelector('.lab-range').value;
  const start  = div.querySelector('.lab-start').value;
  const end    = div.querySelector('.lab-end').value;

  const days = [];
  div.querySelectorAll('.lab-tbody tr').forEach(tr=>{
    const date = tr.cells[0].textContent;
    const status = tr.querySelector('.lab-status').value;
    const advance = parseFloat(tr.querySelector('.lab-adv').value)||0;
    const transport = parseFloat(tr.querySelector('.lab-trans').value)||0;
    days.push({date,status,advance,transport});
  });

  const totalDays = days.reduce((s,d)=> s + (d.status==='P'?1:(d.status==='H'?0.5:0)),0);
  const totalAdvance = days.reduce((s,d)=> s + (d.advance||0),0);
  const totalTransport = days.reduce((s,d)=> s + (d.transport||0),0);
  const totalPay = totalDays * rate;
  const balance = Math.max(0, totalPay - totalAdvance);

// ‚úÖ SAME NAME = SAME ID (case-insensitive)
const existingIndex = DATA.labor.findIndex(x =>
  x.name.trim().toLowerCase() === name.trim().toLowerCase()
);


let id;

if (existingIndex !== -1) {
  // üîÅ Same labor ‚Üí SAME ID
  id = DATA.labor[existingIndex].id;

  // ‡§´‡§ï‡•ç‡§§ ‡§®‡§µ‡•Ä‡§® period add ‡§π‡•ã‡§à‡§≤
  DATA.labor.push({
    id, invno, client, work, name, category,
    rate, range, start, end, days,
    totalDays, totalAdvance, totalTransport,
    totalPay, balance
  });

  console.log(`üîÅ Existing Labor reused ID: ${id}`);

} else {
  // üÜï Brand new labor
  DATA.counters.lab = DATA.counters.lab || 0;
  DATA.counters.lab++;

  id = 'LAB-' + String(DATA.counters.lab).padStart(4,'0');

  DATA.labor.push({
    id, invno, client, work, name, category,
    rate, range, start, end, days,
    totalDays, totalAdvance, totalTransport,
    totalPay, balance
  });

  console.log(`üÜï New Labor Created: ${id}`);
}


  saveData(); 
  alert('‚úÖ Labor saved: ' + id);
  updateLaborTotals(div);
  resetLaborIds(); 
}



/* ---------- Reset numbering after delete ---------- */
function resetLaborIds(){
  DATA.labor.forEach((e,i)=>{
    e.id = 'LAB-' + String(i+1).padStart(4,'0');
  });
  saveData();
}



/* ---------- Update Totals Labels ---------- */
function updateLaborTotals(div){
  let totalDays = 0;
  let adv = 0, trans = 0;

  div.querySelectorAll('.lab-tbody tr').forEach(tr=>{
    const status = tr.querySelector('.lab-status').value;
    const advVal = parseFloat(tr.querySelector('.lab-adv').value)||0;
    const transVal = parseFloat(tr.querySelector('.lab-trans').value)||0;

    if(status==='P') totalDays += 1;
    if(status==='H') totalDays += 0.5;
    adv += advVal;
    trans += transVal;
  });

  const rate = parseFloat(div.querySelector('.lab-rate').value)||0;
  const balance = totalDays * rate - adv;

  div.querySelector('.lab-totdays').textContent = totalDays;
  div.querySelector('.lab-totadv').textContent = adv;
  div.querySelector('.lab-tottrans').textContent = trans;
  div.querySelector('.lab-balance').textContent = balance;
}


/* --- Category helpers --- */
function refreshCategoryOptions(select){
  select.innerHTML = '<option value="">Select</option>';
  DATA.labCategories = DATA.labCategories || [];
  DATA.labCategories.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    select.appendChild(opt);
  });
}
function addCategory(){
  const newCat = prompt("Enter new category:");
  if(newCat){
    DATA.labCategories = DATA.labCategories || [];
    if(!DATA.labCategories.includes(newCat)){
      DATA.labCategories.push(newCat);
      saveData();
      document.querySelectorAll('.lab-category').forEach(sel=> refreshCategoryOptions(sel));
    }
  }
}
function removeCategory(){
  const delCat = prompt("Enter category to remove:");
  if(!delCat) return;
  DATA.labCategories = DATA.labCategories || [];
  DATA.labCategories = DATA.labCategories.filter(c => c !== delCat);
  saveData();
  document.querySelectorAll('.lab-category').forEach(sel=> refreshCategoryOptions(sel));
}

/* ---------- Delete & Reassign IDs (Labor) ---------- */
function deleteLabor(id){
  if(!confirm('Delete this attendance?')) return;

  DATA.labor = DATA.labor.filter(x => x.id !== id);

  saveData();

  if (typeof renderAll === 'function') renderAll();
  if (typeof renderLaborList === 'function') renderLaborList();

  alert('üóëÔ∏è Labor entry deleted');
}



function loadLabor(id){
  const r = DATA.labor.find(x=> x.id === id);
  if(!r) return;
  addLabor(r);
  show('labor');

  // üÜï Invoice No auto-select patch (guaranteed timing)
  setTimeout(() => {
    const lastRow = document.querySelector('#labor-rows .p-3:last-child');
    if (lastRow) {

      // Invoice auto-select
      const invSel = lastRow.querySelector('.lab-inv');
      if (invSel) {
        populateLaborInvoiceDropdown(invSel);
        setTimeout(() => {
          invSel.value = r.invno || '';
        }, 100);
      }

      // üÜï Category auto-select (ensure dropdown refreshed)
      const catSel = lastRow.querySelector('.lab-category');
      if (catSel) {
        refreshCategoryOptions(catSel);
        setTimeout(() => {
          catSel.value = r.category || '';
        }, 100);
      }

    }
  }, 300);
}


function getLaborSummaryByName(laborName) {

  const records = DATA.labor.filter(l =>
    l.name.trim().toLowerCase() === laborName.trim().toLowerCase()
  );

  let totalDays = 0;
  let totalAdvance = 0;
  let totalTransport = 0;
  let totalPay = 0;

  records.forEach(r => {
    totalDays += r.totalDays || 0;
    totalAdvance += r.totalAdvance || 0;
    totalTransport += r.totalTransport || 0;
    totalPay += r.totalPay || 0;
  });

  const balance = Math.max(0, totalPay - totalAdvance);

  return {
    totalDays,
    totalAdvance,
    totalTransport,
    totalPay,
    balance
  };
}










async function deleteLabor(id) {
  if (!confirm('Delete this attendance?')) return;

  // üî∏ Local DATA ‡§Æ‡§ß‡•Ç‡§® ‡§ï‡§æ‡§¢‡§æ
  DATA.labor = DATA.labor.filter(x => x.id !== id);

  // üî∏ Sequential IDs reset ‡§ï‡§∞‡§æ
  DATA.labor.forEach((e, i) => e.id = 'LAB-' + String(i + 1).padStart(4, '0'));
  DATA.counters.lab = DATA.labor.length;

  // üî∏ Local save ‡§ï‡§∞‡§æ
  saveData();

  // üî∏ Firestore ‡§Æ‡§ß‡•ç‡§Ø‡•á update ‡§ï‡§∞‡§æ (overwrite)
  try {
    if (typeof saveToFirestore === 'function') {
      await saveToFirestore();
      console.log('‚úÖ Firestore updated after delete');
    } else {
      console.warn('saveToFirestore not found');
    }
  } catch (err) {
    console.error('‚ùå Firestore update error:', err);
  }

  // üî∏ UI refresh ‡§ï‡§∞‡§æ
  if (typeof renderAll === 'function') renderAll();

  alert('üóëÔ∏è Labor entry deleted successfully.');
}




function shareLabor(id){
  // --- COMPANY INFO ---
  const c = DATA.company || {};
  const cname = c.name || "Vaibhav Enterprises"; // Company name dynamically get kela
    
  const r = DATA.labor.find(x=> x.id === id); 
  if(!r) return;

  const lines = [];
  // Header
  lines.push('üìÖAttendance Details');
  lines.push('');
  lines.push(cname); // ‚úÖ 1. Company name dynamic kela
  lines.push('');
  lines.push('Name: ' + r.name);
  lines.push('Perday: ' + r.rate);
  lines.push('Start Date: ' + r.start);
  lines.push('End Date: ' + r.end);
  lines.push('');

  // ‡§´‡§ï‡•ç‡§§ P/A/H status ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§¶‡§ø‡§µ‡§∏
  r.days.forEach(d => {
    if(d.status && d.status !== " "){
      lines.push(`${d.date}    ${d.status}    Adv. ${money(d.advance||0)}`);
    }
  });

  lines.push('====================');
  lines.push('Tot. Day: ' + r.totalDays + ' Adv. ' + money(r.totalAdvance||0));
  lines.push('====================');
  lines.push('Total Payment: ' + money(r.totalPay||0));
  lines.push('Adv. Payment: ' + money(r.totalAdvance||0));
  lines.push('====================');
  lines.push('Balance Pay. ' + money(r.balance||0));
  lines.push('Extra Allown Pay. ' + money(r.totalTransport||0));  // üöç Transport ‡§µ‡•á‡§ó‡§≥‡§Ç
  lines.push('');
  // Footer
  lines.push('Regarding');
  lines.push('');
  lines.push(cname); // ‚úÖ 2. Company name dynamic kela
  lines.push('');
  lines.push(`Thank you for connecting with ${cname}`); // ‚úÖ 3. Company name dynamic kela
  

  window.open('https://wa.me/?text=' + encodeURIComponent(lines.join('\n')), '_blank');
}



/* ---------- Populate Invoice Dropdown in Each Labor Row ---------- */
function populateLaborInvoiceDropdown(selectEl) {
  if (!selectEl) return;
  selectEl.innerHTML = `<option value="">-- Select Invoice --</option>`;
  (DATA.invoices || []).forEach(inv => {
    const opt = document.createElement("option");
    opt.value = inv.id;
    opt.textContent = `${inv.id} - ${inv.client}`;
    selectEl.appendChild(opt);
  });
}

/* ---------- Handle Invoice Selection (Auto-fill Client & Work) ---------- */
function handleLaborInvoiceSelectRow(sel) {
  const div = sel.closest('.p-3');
  const inv = DATA.invoices.find(x => x.id === sel.value);
  if (!inv) return;
  div.querySelector('.lab-client').value = inv.client || '';
  div.querySelector('.lab-work').value = inv.work || '';
}


function updateLaborSuggestions(q) {
  const dl = document.getElementById('labor-suggestions');
  if (!dl) return;

  dl.innerHTML = '';
  if (!q || q.length < 1) return;

  const seen = new Set();
  const query = q.toLowerCase();

  DATA.labor.forEach(r => {

    // üîπ Labor Name
    if (r.name && r.name.toLowerCase().includes(query) && !seen.has(r.name)) {
      seen.add(r.name);
      const opt = document.createElement('option');
      opt.value = r.name;
      dl.appendChild(opt);
    }

    // üîπ Client Name
    if (r.client && r.client.toLowerCase().includes(query) && !seen.has(r.client)) {
      seen.add(r.client);
      const opt = document.createElement('option');
      opt.value = r.client;
      dl.appendChild(opt);
    }

    // üîπ Work Title
    if (r.work && r.work.toLowerCase().includes(query) && !seen.has(r.work)) {
      seen.add(r.work);
      const opt = document.createElement('option');
      opt.value = r.work;
      dl.appendChild(opt);
    }
  });
}



/* ---------- Export / Report (Name wise All Report) ---------- */
function exportLaborReport() {
  const searchInput = el('labor-search');  // Search field (Labor Name)
  const q = (searchInput?.value || '').trim().toLowerCase();

  let reportList = [];
  let title = '';

  // ‚úÖ ‡§´‡§ï‡•ç‡§§ Name ‡§¶‡§ø‡§≤‡§Ç‡§Ø ‚Üí ‡§§‡•ç‡§Ø‡§æ ‡§®‡§æ‡§µ‡§æ‡§ö‡•á ‡§∏‡§∞‡•ç‡§µ records
  if (q) {
    reportList = DATA.labor.filter(x =>
      x.name && x.name.toLowerCase().includes(q)
    );
    title = `Full Report for Labor: ${searchInput.value}`;
  }
  // üî∏ ‡§ï‡§æ‡§π‡•Ä‡§ö ‡§¶‡§ø‡§≤‡§Ç ‡§®‡§∏‡•á‡§≤ ‚Üí ‡§∏‡§∞‡•ç‡§µ labor
  else {
    reportList = DATA.labor;
    title = 'All Labor Attendance Report';
  }

  if (!reportList.length) {
    alert('No records found for this labor name.');
    return;
  }

  // --- Totals (SUMMARY) ---
  let grandDays = 0;
  let grandAdvance = 0;
  let grandTransport = 0;
  let grandPay = 0;

  // --- Generate report text ---
  let text = `üìã ${title}\n\n`;

  reportList.forEach(r => {
    text += `üßæ ${r.id}\n`;
    if (r.invno) text += `Invoice: ${r.invno}\n`;
    text += `Client: ${r.client}\n`;
    text += `Work: ${r.work}\n`;
    text += `Name: ${r.name}\n`;
    text += `Rate: ‚Çπ${r.rate}\n`;
    text += `Start: ${r.start} | End: ${r.end}\n`;
    text += `Days: ${r.totalDays} | Adv: ‚Çπ${r.totalAdvance} | Transport: ‚Çπ${r.totalTransport}\n`;
    text += `Balance: ‚Çπ${r.balance}\n`;
    text += `---------------------------------\n`;

    // ‚ûï Grand Totals
    grandDays += r.totalDays || 0;
    grandAdvance += r.totalAdvance || 0;
    grandTransport += r.totalTransport || 0;
    grandPay += r.totalPay || (r.totalDays * r.rate);
  });

 const grandBalance = grandPay - grandAdvance;

// --- FINAL SUMMARY ADD ---
text += `\n==============================\n`;
text += `üìä FINAL SUMMARY\n`;
text += `==============================\n`;
text += `Total Days        : ${grandDays}\n`;
text += `Total Advance     : ‚Çπ${grandAdvance}\n`;
text += `Total Transport   : ‚Çπ${grandTransport}\n`;
text += `Total Balance     : ‚Çπ${grandBalance}\n`;
text += `==============================\n`;


  // --- Share / Export via WhatsApp ---
  window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
}






/* -------------------------------------------------------------
 * üèÅ INITIALIZATION & EXPORT/IMPORT
 * ------------------------------------------------------------- */


// Auto-fill Date on page load for relevant fields
document.addEventListener("DOMContentLoaded", ()=>{ 
    [el("est-date"), el("inv-date"), el("ord-date")].forEach(field => {
        if(field){
            const today = new Date().toISOString().split("T")[0];
            field.value = today;
        }
    });

    loadData(); // Load all data from Local Storage when the app starts
});

window.onload = async function () {
  try {
    // ‚úÖ Try to get next estimate number from Google Sheet first
    if (typeof generateNextEstimateNo === 'function') {
      const val = await generateNextEstimateNo().catch(() => null);
      if (val) el('est-no').value = val;
      else if (typeof generateAvailableEstimateNo === 'function')
        el('est-no').value = generateAvailableEstimateNo();
      else el('est-no').value = 'EST-0001';
    } 
    // ‚úÖ Otherwise, fallback to local or default
    else if (typeof generateAvailableEstimateNo === 'function') {
      el('est-no').value = generateAvailableEstimateNo();
    } else {
      el('est-no').value = 'EST-0001';
    }
  } catch (err) {
    console.error('Error setting est-no on load:', err);
    el('est-no').value = 'EST-0001';
  }

  // ‚úÖ Invoice number generation (existing logic)
  if (typeof generateAvailableInvoiceNo === 'function') {
    el('inv-no').value = generateAvailableInvoiceNo();
  }
};





document.addEventListener("DOMContentLoaded", () => {
  loadData();
  refreshMaterialsDatalist();
});


// üîÑ Invoice ‡§®‡§ø‡§µ‡§°‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ Client & Work auto-fill
document.getElementById("order-invoice-select").addEventListener("change", function () {
  const invId = this.value;
  if (!invId) return;

  const inv = (DATA.invoices || []).find(i => i.id === invId);
  if (inv) {
    el("ord-client").value = inv.client || "";
    el("ord-work").value = inv.work || "";
  }
});



document.addEventListener("DOMContentLoaded", () => {
  if (typeof syncEstimatesFromSheet === "function") {
    syncEstimatesFromSheet(); // üîÑ Sheet ‚Üí Local auto-sync
  }
});


// üè† App open zalyavar Home tab auto-show kara
document.addEventListener("DOMContentLoaded", () => {
  renderAll?.();   // renderAll() function ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§ö‡§æ‡§≤‡•á‡§≤
  show("home");    // Home tab default open ‡§π‡•ã‡§à‡§≤
});


// -------------------------------------------------
// ‚¨áÔ∏è EXCEL IMPORT/EXPORT (Using local DATA object) ‚¨áÔ∏è
// -------------------------------------------------

function exportToExcel() {
    if (!DATA || Object.keys(DATA).length === 0) {
        alert("No data to export.");
        return;
    }

    const wb = XLSX.utils.book_new();

    // Helper to convert array of objects to sheet
    const addSheet = (dataArray, sheetName) => {
        if (dataArray && dataArray.length > 0) {
            // Flatten nested objects (like items array in estimate/invoice)
            const flatData = dataArray.map(item => {
                const { items, ...rest } = item;
                if (items && Array.isArray(items)) {
                    // For records with nested items (like invoices/estimates/orders)
                    return items.map(subItem => ({ ...rest, ...subItem }));
                }
                return rest;
            }).flat();

            const ws = XLSX.utils.json_to_sheet(flatData);
            XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 30));
        }
    };

    addSheet(DATA.invoices, 'Invoices');
    addSheet(DATA.estimates, 'Estimates');
    addSheet(DATA.expenses, 'Expenses');
    addSheet(DATA.payments, 'Received Payments');
    addSheet(DATA.paidPayments, 'Paid Payments');
    addSheet(DATA.orders, 'Orders');
    addSheet(DATA.measurements, 'Measurements');
    addSheet(DATA.daily, 'Daily Reports');
    addSheet(DATA.labor, 'Labor Attendance');
    
    // Add Metadata Sheet (Counters and Categories)
    const metaData = [
        { Key: 'Counters', Value: JSON.stringify(DATA.counters) },
        { Key: 'Categories', Value: JSON.stringify(DATA.categories) }
    ];
    const wsMeta = XLSX.utils.json_to_sheet(metaData);
    XLSX.utils.book_append_sheet(wb, wsMeta, 'MetaData');


    XLSX.writeFile(wb, 'Vaibhav_Enterprises_Data.xlsx');
}

function importFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        let importedData = {};
        let newCounters = {};
        
        workbook.SheetNames.forEach(sheetName => {
            const worksheet = workbook.Sheets[sheetName];
            let json = XLSX.utils.sheet_to_json(worksheet);

            if (sheetName === 'MetaData') {
                const countersRow = json.find(r => r.Key === 'Counters');
                if (countersRow) newCounters = JSON.parse(countersRow.Value);
                const categoriesRow = json.find(r => r.Key === 'Categories');
                if (categoriesRow) importedData.categories = JSON.parse(categoriesRow.Value);
                return;
            }

            // Simple import of flat data, assuming the user is importing their own exported format.
            if (sheetName.includes('Invoices')) importedData.invoices = json;
            if (sheetName.includes('Estimates')) importedData.estimates = json;
            if (sheetName.includes('Expenses')) importedData.expenses = json;
            if (sheetName.includes('Received Payments')) importedData.payments = json;
            if (sheetName.includes('Paid Payments')) importedData.paidPayments = json;
            if (sheetName.includes('Orders')) importedData.orders = json;
            if (sheetName.includes('Measurements')) importedData.measurements = json;
            if (sheetName.includes('Daily Reports')) importedData.daily = json;
            if (sheetName.includes('Labor')) importedData.labor = json;
        });

        // Merge imported data with existing local data
        DATA = { ...DATA, ...importedData };
        // Overwrite counters (important for new ID generation)
        DATA.counters = { ...DATA.counters, ...newCounters };
        
        saveData();
        alert("Data imported successfully! The app has reloaded with new data.");
    };
    reader.readAsArrayBuffer(file);
}

// -------------------------------------------------
// ‚¨áÔ∏è Category Chart  ‚¨áÔ∏è
// -------------------------------------------------

let categoryChart;

function updateHomeDashboard(invoiceId) {
  // üîç Find Expense record by Invoice No
  const rec = (DATA.expenses || []).find(x => x.invoiceNo === invoiceId);
  if (!rec) {
    el("invoice-summary").innerHTML = `<p class="text-center text-gray-400">No expense data found for Invoice ${invoiceId}.</p>`;
    return;
  }

  // --- Convert merged fields back into item array ---
  const names = (rec.name || "").split(",").map(s => s.trim());
  const cats = (rec.category || "").split(",").map(s => s.trim());
  const qtys = (rec.quantity || "").split(",").map(s => s.trim());
  const units = (rec.unit || "").split(",").map(s => s.trim());
  const rates = (rec.rate || "").split(",").map(s => s.trim());
  const dates = (rec.date || "").split(",").map(s => s.trim());

  const items = names.map((name, i) => {
    const qty = parseFloat(qtys[i]) || 0;
    const rate = parseFloat(rates[i]) || 0;
    return {
      date: dates[i] || "-",
      name,
      category: cats[i] || "Other",
      qty,
      unit: units[i] || "",
      rate,
      amount: qty * rate
    };
  });

  // --- Summary calculations ---
   // --- Summary calculations ---
  const total = items.reduce((sum, it) => sum + it.amount, 0);

  // ‚úÖ Invoice object ‡§∂‡•ã‡§ß‡§æ (multiple key fallback)
  const income =
    (DATA.invoices || []).find(i =>
      i.invoiceNo === invoiceId ||
      i.id === invoiceId ||
      i.invoice === invoiceId ||
      i.invoiceId === invoiceId
    );

  const revenue = income ? parseFloat(income.total || income.amount || income.grandTotal || 0) : 0;
  const profit = revenue - total;


  // --- Invoice Summary UI update ---
  el("current-invoice-no").textContent = invoiceId;
  el("invoice-summary").innerHTML = `
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
      <div class="bg-gray-800 p-3 rounded">
        <p class="text-gray-400">Total Expenses</p>
        <h3 class="text-red-400 text-lg font-semibold">‚Çπ${total.toFixed(2)}</h3>
      </div>
      <div class="bg-gray-800 p-3 rounded">
        <p class="text-gray-400">Invoice Amount</p>
        <h3 class="text-blue-400 text-lg font-semibold">‚Çπ${revenue.toFixed(2)}</h3>
      </div>
      <div class="bg-gray-800 p-3 rounded">
        <p class="text-gray-400">Profit</p>
        <h3 class="text-green-400 text-lg font-semibold">‚Çπ${profit.toFixed(2)}</h3>
      </div>
      <div class="bg-gray-800 p-3 rounded">
        <p class="text-gray-400">Items Count</p>
        <h3 class="text-yellow-400 text-lg font-semibold">${items.length}</h3>
      </div>
    </div>
  `;

  // --- Category totals ---
  const categoryTotals = {};
  items.forEach(i => {
    const cat = i.category || "Other";
    if (!categoryTotals[cat]) categoryTotals[cat] = 0;
    categoryTotals[cat] += i.amount;
  });

  const labels = Object.keys(categoryTotals);
  const data = Object.values(categoryTotals);
  const chartCanvas = document.getElementById("categoryChart");
  if (!chartCanvas) return;

  const ctx = chartCanvas.getContext("2d");

  // üîÑ Destroy old chart before creating new
  if (categoryChart && typeof categoryChart.destroy === "function") {
    try { categoryChart.destroy(); } catch (err) {}
  }

  // üé® Color palette
  function getColors(n) {
    const palette = [
      "rgba(255, 99, 132, 0.7)",
      "rgba(54, 162, 235, 0.7)",
      "rgba(255, 206, 86, 0.7)",
      "rgba(75, 192, 192, 0.7)",
      "rgba(153, 102, 255, 0.7)",
      "rgba(255, 159, 64, 0.7)",
      "rgba(0, 200, 150, 0.7)"
    ];
    return Array.from({ length: n }, (_, i) => palette[i % palette.length]);
  }

  // üìä Create new chart
  categoryChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: "Category Expenses (‚Çπ)",
        data,
        backgroundColor: getColors(labels.length),
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      animation: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `‚Çπ ${ctx.formattedValue}`
          }
        }
      },
      scales: {
        y: { beginAtZero: true, ticks: { color: "#fff" } },
        x: { ticks: { color: "#fff" } }
      }
    }
  });

  show("home");
}

// üß† Event: when user selects invoice in Expenses tab
document.addEventListener("DOMContentLoaded", () => {
  const invoiceSelect = document.getElementById("exp-invoice-select");
  if (invoiceSelect) {
    invoiceSelect.addEventListener("change", () => {
      const selectedInv = invoiceSelect.value || "";
      if (selectedInv) updateHomeDashboard(selectedInv);
    });
  }
});


/* ---------- Populate Home Invoice Dropdown ---------- */
function populateHomeInvoices() {
  const sel = document.getElementById("home-inv-select");
  if (!sel) return;
  sel.innerHTML = `<option value="">-- Select Invoice --</option>`;
  (DATA.invoices || []).forEach(inv => {
    const opt = document.createElement("option");
    opt.value = inv.id;
    opt.textContent = `${inv.id} - ${inv.client}`;
    sel.appendChild(opt);
  });
}





// ‚úÖ Add Reset Data Button inside Navigation Bar
function addResetButtonToNavbar() {
  const nav = document.querySelector(".nav .flex.gap-2.items-center");
  if (!nav) {
    console.warn("‚ö†Ô∏è Navigation bar not found!");
    return;
  }

  // --- Reset Button ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ ---
  const resetBtn = document.createElement("button");
  resetBtn.textContent = "üîÅ Reset Data";
  resetBtn.className = "smallbtn flex-shrink-0";
  resetBtn.style.background = "#dc2626";
  resetBtn.style.color = "#fff";
  resetBtn.style.fontWeight = "bold";
  resetBtn.style.borderRadius = "6px";

  // --- ‡§¨‡§ü‡§£‡§æ‡§µ‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï action ---
  resetBtn.onclick = () => {
    try {
      // ‚úÖ Step 1: Excel Backup ‚Äî ‡§•‡•á‡§ü exportToExcel() function ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§æ
      exportToExcel();  

      // ‚úÖ Step 2: LocalStorage Clear (alert/confirm ‡§®‡§ï‡•ã)
      localStorage.clear();

      // ‚úÖ Step 3: Auto Reload
      setTimeout(() => {
        location.reload();
      }, 2000);
    } catch (err) {
      console.error("‚ùå Reset Error:", err);
    }
  };

  // --- Export Excel ‡§¨‡§ü‡§£‡§ö‡•ç‡§Ø‡§æ ‡§Ü‡§ß‡•Ä add ‡§ï‡§∞‡§æ ---
  const exportBtn = nav.querySelector("button[onclick='exportToExcel()']");
  if (exportBtn) {
    nav.insertBefore(resetBtn, exportBtn);
  } else {
    nav.appendChild(resetBtn);
  }

  console.log("‚úÖ Reset Data button added successfully to navigation bar");
}

// ‚úÖ Run on Page Load
window.addEventListener("DOMContentLoaded", addResetButtonToNavbar);



 

</script>


<!-- ========== Firebase Firestore integration (paste BEFORE </body>) ========== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, setDoc, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // ====== ‡§§‡•Å‡§Æ‡§ö‡§æ firebaseConfig ======
  const firebaseConfig = {
    apiKey: "AIzaSyBaaV8A69XqckjnVuMCy6F5GyEuqRJvt_Y",
    authDomain: "vaibhav-enterprises-ee336.firebaseapp.com",
    projectId: "vaibhav-enterprises-ee336",
    storageBucket: "vaibhav-enterprises-ee336.firebasestorage.app",
    messagingSenderId: "172689572436",
    appId: "1:172689572436:web:5a68b14a5fea0eb44fa3c1",
    measurementId: "G-V4MFRFH744"
  };

  // Initialize
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Document path ‚Äî ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§¨‡§¶‡§≤‡•Ç ‡§∂‡§ï‡§§‡§æ (company-wise ‡§Ö‡§≤‡§ó ‡§ï‡§∞‡§æ‡§Ø‡§ö‡§æ ‡§§‡§∞)
  const DOC_PATH = { collection: "apps", docId: "vaibhav_enterprises_data" };

  // Save local DATA object into Firestore
  async function saveToFirestore() {
    try {
      // write entire DATA object (simple approach)
      await setDoc(doc(db, DOC_PATH.collection, DOC_PATH.docId), DATA);
      console.log("‚úÖ Firestore save success");
    } catch (err) {
      console.error("‚ùå Firestore save error:", err);
    }
  }

  // Load data from Firestore into local DATA/localStorage
  async function loadFromFirestore() {
    try {
      const snap = await getDoc(doc(db, DOC_PATH.collection, DOC_PATH.docId));
      if (snap.exists()) {
        const remote = snap.data();
        // merge or overwrite ‚Äî ‡§Ø‡•á‡§•‡•á ‡§Æ‡•Ä overwrite ‡§ï‡§∞‡§§‡•ã (‡§∏‡§∞‡§≤)
        DATA = remote;
        localStorage.setItem(KEY, JSON.stringify(DATA));
        renderAll();
        console.log("‚úÖ Firestore data loaded");
      } else {
        console.log("‚ö†Ô∏è No Firestore document found at", DOC_PATH);
      }
    } catch (err) {
      console.error("‚ùå Firestore load error:", err);
    }
  }

  // ‡§õ‡•ã‡§ü‡•á helper: save on explicit call and when saveData() is invoked
  window.saveToFirestore = saveToFirestore;
  window.loadFromFirestore = loadFromFirestore;

 // When page loads, always load from Firestore (so mobile + desktop stay in sync)
window.addEventListener("load", () => {
  console.log("üîÑ Loading latest data from Firestore...");
  loadFromFirestore();  // ‚úÖ ‡§®‡•á‡§π‡§Æ‡•Ä Firestore ‡§Æ‡§ß‡•Ç‡§® ‡§°‡•á‡§ü‡§æ ‡§Ü‡§£‡§æ
});


  // OPTIONAL: If you want automatic push on every local save, patch saveData() (see below)
</script>
<!-- ========== End Firebase Firestore integration ========== -->



</body>
</html>
